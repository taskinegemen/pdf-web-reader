function BookReader(){this.constMode1up=1;this.constMode2up=2;this.constModeThumb=3;this.reduce=4;this.padding=10;this.mode=this.constMode1up;this.ui="full";this.uiAutoHide=false;this.thumbWidth=100;this.thumbRowBuffer=2;this.thumbColumns=6;this.thumbMaxLoading=4;this.thumbPadding=10;this.displayedRows=[];this.displayedIndices=[];this.imgs={};this.prefetchedImgs={};this.timer=null;this.animating=false;this.auto=false;this.autoTimer=null;this.flipSpeed="fast";this.twoPagePopUp=null;this.leafEdgeTmp=null;this.embedPopup=null;this.printPopup=null;this.searchTerm="";this.searchResults=null;this.firstIndex=null;this.lastDisplayableIndex2up=null;this.logoURL="http://www.archive.org";this.imagesBaseURL="/bookreader/images/";this.reductionFactors=[{reduce:.5,autofit:null},{reduce:1,autofit:null},{reduce:2,autofit:null},{reduce:3,autofit:null},{reduce:4,autofit:null},{reduce:6,autofit:null}];this.onePage={autofit:"height"};this.twoPage={coverInternalPadding:0,coverExternalPadding:0,bookSpineDivWidth:64,autofit:"auto"};this.features={};this.ttsPlaying=false;this.ttsIndex=null;this.ttsPosition=-1;this.ttsBuffering=false;this.ttsPoller=null;this.ttsFormat=null;return this}(function(e){function t(){setTimeout(function(){e("#BRnavCntlBtm").removeClass("BRdn").addClass("BRup")},3e3)}BookReader.prototype.init=function(){var t=undefined;this.pageScale=this.reduce;var n={};if(window.location.hash){n=this.paramsFromFragment(window.location.hash)}else{if("defaults"in this){n=this.paramsFromFragment(this.defaults)}}if(!this.canSwitchToMode(this.mode)){this.mode=this.constMode1up}if("undefined"!=typeof n.index){t=n.index}else if("undefined"!=typeof n.page){t=this.getPageIndex(n.page)}if("undefined"==typeof t){if("undefined"!=typeof this.titleLeaf){if(this.numLeafs>2){t=this.leafNumToIndex(this.titleLeaf)}}}if("undefined"==typeof t){t=0}if("undefined"!=typeof n.mode){this.mode=n.mode}document.title=this.shortTitle(50);e("#BookReader").empty();this.initToolbar(this.mode,this.ui);e("#BookReader").append("<div id='BRcontainer' dir='ltr'></div>");e("#BRcontainer").append("<div id='BRpageview'></div>");e("#BRcontainer").bind("scroll",this,function(e){e.data.loadLeafs()});this.setupKeyListeners();this.startLocationPolling();e(window).bind("resize",this,function(t){if(1==t.data.mode){if(t.data.autofit){t.data.resizePageView()}t.data.centerPageView();e("#BRpageview").empty();t.data.displayedIndices=[];t.data.updateSearchHilites();t.data.loadLeafs()}else if(3==t.data.mode){t.data.prepareThumbnailView()}else{if(t.data.twoPage.autofit){t.data.prepareTwoPageView()}else{var n=t.data.twoPageGetViewCenter();var r=false;if(t.data.twoPage.totalWidth<e("#BRcontainer").attr("clientWidth")){n.percentageX=.5;r=true}if(t.data.twoPage.totalHeight<e("#BRcontainer").attr("clientHeight")){n.percentageY=.5;r=true}if(r){t.data.twoPageCenterView(n.percentageX,n.percentageY)}}}});if(this.protected){e(".BRpagediv1up").live("contextmenu dragstart",this,function(e){return false});e(".BRpageimage").live("contextmenu dragstart",this,function(e){return false});e(".BRpagedivthumb").live("contextmenu dragstart",this,function(e){return false})}e(".BRpagediv1up").bind("mousedown",this,function(e){return false});if(1==this.mode){this.firstIndex=t;this.prepareOnePageView();this.jumpToIndex(t)}else if(3==this.mode){this.firstIndex=t;this.prepareThumbnailView();this.jumpToIndex(t)}else{this.displayedIndices=[0];this.firstIndex=t;this.displayedIndices=[this.firstIndex];this.prepareTwoPageView()}this.updateFromParams(n);if(this.ui=="embed"){this.initEmbedNavbar()}else{this.initNavbar()}this.bindNavigationHandlers();this.initUIStrings();if(this.getOpenLibraryRecord){this.getOpenLibraryRecord(this.gotOpenLibraryRecord)}};BookReader.prototype.setupKeyListeners=function(){var t=this;var n=33;var r=34;var i=35;var s=36;var o=37;var u=38;var a=39;var f=40;e(document).keydown(function(e){if(!t.keyboardNavigationIsDisabled(e)){switch(e.keyCode){case n:case u:if(2==t.mode){e.preventDefault();t.prev()}break;case f:case r:if(2==t.mode){e.preventDefault();t.next()}break;case i:e.preventDefault();t.last();break;case s:e.preventDefault();t.first();break;case o:if(2==t.mode){e.preventDefault();t.left()}break;case a:if(2==t.mode){e.preventDefault();t.right()}break}}})};BookReader.prototype.drawLeafs=function(){if(1==this.mode){this.drawLeafsOnePage()}else if(3==this.mode){this.drawLeafsThumbnail()}else{this.drawLeafsTwoPage()}};BookReader.prototype.bindGestures=function(e){e.unbind("gesturechange").bind("gesturechange",function(e){e.preventDefault();if(e.originalEvent.scale>1.5){br.zoom(1)}else if(e.originalEvent.scale<.6){br.zoom(-1)}})};BookReader.prototype.setClickHandler2UP=function(t,n,r){e(t).unbind("click").bind("click",n,function(e){r(e)})};BookReader.prototype.drawLeafsOnePage=function(){this.timer=null;var t=e("#BRcontainer").attr("scrollTop");var n=t+e("#BRcontainer").height();var r=[];var i;var s=0;var o=0;for(i=0;i<this.numLeafs;i++){var u=parseInt(this._getPageHeight(i)/this.reduce);o+=u;var a=s>=t&&s<=n;var f=o>=t&&o<=n;var l=s<=t&&o>=n;if(a|f|l){r.push(i)}s+=u+10;o+=10}var c=r[0];if(c!=this.firstIndex){this.willChangeToIndex(c)}this.firstIndex=c;if(this.displayedIndices.length>0){this.updateLocationHash()}if(0!=c&&1<this.reduce){c--;r.unshift(c)}var h=r[r.length-1];if(this.numLeafs-1!=h&&1<this.reduce){r.push(h+1)}s=0;var i;for(i=0;i<c;i++){s+=parseInt(this._getPageHeight(i)/this.reduce)+10}var p=e("#BRcontainer").attr("scrollWidth");for(i=0;i<r.length;i++){var d=r[i];var u=parseInt(this._getPageHeight(d)/this.reduce);if(BookReader.util.notInArray(r[i],this.displayedIndices)){var v=parseInt(this._getPageWidth(d)/this.reduce);var m=document.createElement("div");m.className="BRpagediv1up";m.id="pagediv"+d;m.style.position="absolute";e(m).css("top",s+"px");var g=p-v>>1;if(g<0)g=0;e(m).css("left",g+"px");e(m).css("width",v+"px");e(m).css("height",u+"px");e("#BRpageview").append(m);var y=document.createElement("img");y.src=this._getPageURI(d,this.reduce,0);e(y).addClass("BRnoselect");e(y).css("width",v+"px");e(y).css("height",u+"px");e(m).append(y)}else{}s+=u+10}for(i=0;i<this.displayedIndices.length;i++){if(BookReader.util.notInArray(this.displayedIndices[i],r)){var d=this.displayedIndices[i];e("#pagediv"+d).remove()}else{}}this.displayedIndices=r.slice();this.updateSearchHilites();if(null!=this.getPageNum(c)){e("#BRpagenum").val(this.getPageNum(this.currentIndex()))}else{e("#BRpagenum").val("")}this.updateToolbarZoom(this.reduce)};BookReader.prototype.drawLeafsThumbnail=function(t){this.timer=null;var n=e("#BRcontainer").attr("scrollWidth")-20;var r;var i;var s;var o=0;var u=0;var a=0;var f=0;var l=0;var c=[];var h=this;var p;for(r=0;r<this.numLeafs;r++){i=this.thumbWidth;if(o+(i+this.thumbPadding)>n){f++;o=0;l=0}if(c[f]===undefined){c[f]={}}if(c[f].leafs===undefined){c[f].leafs=[];c[f].height=0;c[f].top=0}c[f].leafs[l]={};c[f].leafs[l].num=r;c[f].leafs[l].left=o;s=parseInt(this.getPageHeight(c[f].leafs[l].num)*this.thumbWidth/this.getPageWidth(c[f].leafs[l].num),10);if(s>c[f].height){c[f].height=s}if(l===0){u+=this.thumbPadding+c[f].height}o+=i+this.thumbPadding;if(o>a){a=o}l++;if(r==t){p=u-this.thumbPadding-c[f].height}}e("#BRpageview").height(u);var d=Math.floor((e("#BRcontainer").attr("scrollWidth")-a)/2)-14;if(typeof p!="undefined"){e("#BRcontainer").scrollTop(p)}var v=e("#BRcontainer").attr("scrollTop");var m=v+e("#BRcontainer").height();var g=0;var y=0;var b=[];var w=this.numLeafs-1;var E=0;for(r=0;r<c.length;r++){y+=this.thumbPadding+c[r].height;var S=g>=v&&g<=m;var x=y>=v&&y<=m;var T=g<=v&&y>=m;if(S|x|T){b.push(r);if(c[r].leafs[0].num<w){w=c[r].leafs[0].num}if(c[r].leafs[c[r].leafs.length-1].num>E){E=c[r].leafs[c[r].leafs.length-1].num}}if(g>c[r].top){c[r].top=g}g=y}var N=b[0];var C=b[b.length-1];for(r=1;r<this.thumbRowBuffer+1;r++){if(C+r<c.length){b.push(C+r)}}for(r=1;r<this.thumbRowBuffer+1;r++){if(N-r>=0){b.push(N-r)}}var k;var L;var A;var O;var M;var _;var D;var P;for(r=0;r<b.length;r++){if(BookReader.util.notInArray(b[r],this.displayedRows)){L=b[r];for(k=0;k<c[L].leafs.length;k++){O=k;leaf=c[L].leafs[k].num;i=this.thumbWidth;s=parseInt(this.getPageHeight(leaf)*this.thumbWidth/this.getPageWidth(leaf),10);g=c[L].top;A=c[L].leafs[O].left+d;if("rl"==this.pageProgression){A=n-i-A}M=document.createElement("div");M.id="pagediv"+leaf;M.style.position="absolute";M.className="BRpagedivthumb";A+=this.thumbPadding;e(M).css("top",g+"px");e(M).css("left",A+"px");e(M).css("width",i+"px");e(M).css("height",s+"px");_=document.createElement("a");e(_).data("leaf",leaf);e(_).bind("tap",function(t){h.firstIndex=e(this).data("leaf");h.switchMode(h.constMode1up);t.preventDefault();t.stopPropagation()});e(M).append(_);e("#BRpageview").append(M);D=document.createElement("img");var H=Math.floor(this.getPageWidth(leaf)/this.thumbWidth);e(D).attr("src",this.imagesBaseURL+"transparent.png").css({width:i+"px",height:s+"px"}).addClass("BRlazyload").data("srcURL",this._getPageURI(leaf,H));e(_).append(D)}}}var B;for(r=0;r<this.displayedRows.length;r++){if(BookReader.util.notInArray(this.displayedRows[r],b)){L=this.displayedRows[r];for(B=0;B<c[L].leafs.length;B++){O=c[L].leafs[B].num;e("#pagediv"+O).remove()}}else{}}var j=this.currentIndex();if(j<w){this.willChangeToIndex(w);this.setCurrentIndex(w)}else if(j>E){this.willChangeToIndex(E);this.setCurrentIndex(E)}this.displayedRows=b.slice();if(this.displayedRows.length>0){this.updateLocationHash()}e(".BRpagedivthumb_highlight").removeClass("BRpagedivthumb_highlight");e("#pagediv"+this.currentIndex()).addClass("BRpagedivthumb_highlight");this.lazyLoadThumbnails();if(null!==this.getPageNum(this.currentIndex())){e("#BRpagenum").val(this.getPageNum(this.currentIndex()))}else{e("#BRpagenum").val("")}this.updateToolbarZoom(this.reduce)};BookReader.prototype.lazyLoadThumbnails=function(){e(".BRlazyloading").filter("[complete=true]").removeClass("BRlazyloading");var t=e(".BRlazyloading").length;var n=this.thumbMaxLoading-t;var r=this;if(n>0){e("#BRpageview img.BRlazyload").filter(":lt("+n+")").each(function(){r.lazyLoadImage(this)})}};BookReader.prototype.lazyLoadImage=function(t){var n=new Image;var r=this;e(n).addClass("BRlazyloading").one("load",function(){e(this).removeClass("BRlazyloading");setTimeout(function(){r.lazyLoadThumbnails()},100)}).one("error",function(){e(this).removeClass("BRlazyloading")}).css({width:e(t).width()+"px",height:e(t).height()+"px"}).attr({width:e(t).width(),height:e(t).height(),src:e(t).data("srcURL")});e(t).before(n).remove();n=null};BookReader.prototype.drawLeafsTwoPage=function(){var t=e("#BRtwopageview").attr("scrollTop");var n=t+e("#BRtwopageview").height();var r=this.twoPage.currentIndexL;var i=this._getPageHeight(r);var s=this._getPageWidth(r);var o=this.leafEdgeWidth(r);var u=this.twoPage.edgeWidth-o;var a=this.twoPage.bookCoverDivWidth;var f=this.twoPage.middle;var l=this.twoPageTop();var c=this.twoPage.bookCoverDivLeft;this.twoPage.scaledWL=this.getPageWidth2UP(r);this.twoPage.gutter=this.twoPageGutter();this.prefetchImg(r);e(this.prefetchedImgs[r]).css({position:"absolute",left:this.twoPage.gutter-this.twoPage.scaledWL+"px",right:"",top:l+"px",height:this.twoPage.height+"px",width:this.twoPage.scaledWL+"px",zIndex:2}).appendTo("#BRtwopageview");var h=this.twoPage.currentIndexR;var p=this._getPageHeight(h);var d=this._getPageWidth(h);this.twoPage.scaledWR=this.getPageWidth2UP(h);this.prefetchImg(h);e(this.prefetchedImgs[h]).css({position:"absolute",left:this.twoPage.gutter+"px",right:"",top:l+"px",height:this.twoPage.height+"px",width:this.twoPage.scaledWR+"px",zIndex:2}).appendTo("#BRtwopageview");this.displayedIndices=[this.twoPage.currentIndexL,this.twoPage.currentIndexR];this.setMouseHandlers2UP();this.twoPageSetCursor();this.updatePageNumBox2UP();this.updateToolbarZoom(this.reduce)};BookReader.prototype.updatePageNumBox2UP=function(){if(null!=this.getPageNum(this.twoPage.currentIndexL)){e("#BRpagenum").val(this.getPageNum(this.currentIndex()))}else{e("#BRpagenum").val("")}this.updateLocationHash()};BookReader.prototype.loadLeafs=function(){var e=this;if(null==this.timer){this.timer=setTimeout(function(){e.drawLeafs()},250)}else{clearTimeout(this.timer);this.timer=setTimeout(function(){e.drawLeafs()},250)}};BookReader.prototype.zoom=function(e){switch(this.mode){case this.constMode1up:if(e==1){return this.zoom1up("in")}else{return this.zoom1up("out")};case this.constMode2up:if(e==1){return this.zoom2up("in")}else{return this.zoom2up("out")};case this.constModeThumb:return this.zoomThumb(e)}};BookReader.prototype.zoom1up=function(t){if(2==this.mode){this.switchMode(1);return}var n=this.nextReduce(this.reduce,t,this.onePage.reductionFactors);if(this.reduce==n.reduce){return}this.reduce=n.reduce;this.onePage.autofit=n.autofit;this.pageScale=this.reduce;this.resizePageView();e("#BRpageview").empty();this.displayedIndices=[];this.loadLeafs();this.updateToolbarZoom(this.reduce);this.removeSearchHilites();this.updateSearchHilites()};BookReader.prototype.resizePageView=function(){switch(this.mode){case this.constMode1up:case this.constMode2up:this.resizePageView1up();break;case this.constModeThumb:this.prepareThumbnailView(this.currentIndex());break;default:alert("Resize not implemented for this mode")}};BookReader.prototype.resizePageView1up=function(){var t;var n=0;var r=e("#BRcontainer").attr("clientWidth");var i=e("#BRcontainer").attr("scrollTop");var s=e("#BRcontainer").attr("scrollLeft");var o=e("#BRpageview").height();var u=e("#BRpageview").width();var a=0;if(i>0){var f=this.centerY1up();var l=this.centerX1up();a=f/o}else{var c=this.getPageHeight(this.currentIndex())/this.reduce*.6;var h=this.onePageGetPageTop(this.currentIndex())+c;var p=this.onePageCalculateViewDimensions(this.reduce,this.padding);a=h/p.height}this.onePageCalculateReductionFactors(e("#BRcontainer").attr("clientWidth"),e("#BRcontainer").attr("clientHeight"));if(this.onePage.autofit){var d=this.nextReduce(this.reduce,this.onePage.autofit,this.onePage.reductionFactors);this.reduce=d.reduce}var v=this.onePageCalculateViewDimensions(this.reduce,this.padding);e("#BRpageview").height(v.height);e("#BRpageview").width(v.width);var m=a*v.height;var g=Math.max(0,Math.floor(m-e("#BRcontainer").height()/2));e("#BRcontainer").attr("scrollTop",g);var y=l*(r/u);var b=y-e("#BRcontainer").attr("clientWidth")/2;b=Math.max(b,0);e("#BRcontainer").attr("scrollLeft",b);this.loadLeafs();this.removeSearchHilites();this.updateSearchHilites()};BookReader.prototype.onePageCalculateViewDimensions=function(e,t){var n=0;var r=0;for(i=0;i<this.numLeafs;i++){r+=parseInt(this._getPageHeight(i)/this.reduce)+this.padding;var s=parseInt(this._getPageWidth(i)/this.reduce);if(s>n)n=s}return{width:n,height:r}};BookReader.prototype.centerX1up=function(){var t;if(e("#BRpageview").width()<e("#BRcontainer").attr("clientWidth")){t=e("#BRpageview").width()}else{t=e("#BRcontainer").attr("scrollLeft")+e("#BRcontainer").attr("clientWidth")/2}t=Math.floor(t);return t};BookReader.prototype.centerY1up=function(){var t=e("#BRcontainer").attr("scrollTop")+e("#BRcontainer").height()/2;return Math.floor(t)};BookReader.prototype.centerPageView=function(){var t=e("#BRcontainer").attr("scrollWidth");var n=e("#BRcontainer").attr("clientWidth");if(t>n){e("#BRcontainer").attr("scrollLeft",(t-n)/2)}};BookReader.prototype.zoom2up=function(e){this.stopFlipAnimations();this.twoPageCalculateReductionFactors();var t=this.nextReduce(this.reduce,e,this.twoPage.reductionFactors);if(this.reduce==t.reduce&&this.twoPage.autofit==t.autofit){return}this.twoPage.autofit=t.autofit;this.reduce=t.reduce;this.pageScale=this.reduce;var n=this.twoPageGetViewCenter();if(1==e){for(var r in this.prefetchedImgs){delete this.prefetchedImgs[r]}}this.prepareTwoPageView(n.percentageX,n.percentageY)};BookReader.prototype.zoomThumb=function(e){var t=this.thumbColumns;switch(e){case-1:this.thumbColumns+=1;break;case 1:this.thumbColumns-=1;break}if(this.thumbColumns<2){this.thumbColumns=2}else if(this.thumbColumns>8){this.thumbColumns=8}if(this.thumbColumns!=t){this.prepareThumbnailView()}};BookReader.prototype.getThumbnailWidth=function(t){var n=(t+1)*this.thumbPadding;var r=(e("#BRpageview").width()-n)/(t+.5);return parseInt(r)};BookReader.prototype.quantizeReduce=function(e,t){var n=t[0].reduce;var r=Math.abs(e-n);for(var i=1;i<t.length;i++){newDistance=Math.abs(e-t[i].reduce);if(newDistance<r){r=newDistance;n=t[i].reduce}}return n};BookReader.prototype.nextReduce=function(e,t,n){if(t=="in"){var r=0;for(var i=1;i<n.length;i++){if(n[i].reduce<e){r=i}}return n[r]}else if(t=="out"){var s=n.length-1;var r=s;for(var i=s;i>=0;i--){if(n[i].reduce>e){r=i}}return n[r]}for(var i=0;i<n.length;i++){if(n[i].autofit==t){return n[i]}}alert("Could not find reduction factor for direction "+t);return n[0]};BookReader.prototype._reduceSort=function(e,t){return e.reduce-t.reduce};BookReader.prototype.jumpToPage=function(t){var n;var r=new RegExp("^leaf(\\d+)");leafMatch=r.exec(t);if(leafMatch){console.log(leafMatch[1]);n=this.leafNumToIndex(parseInt(leafMatch[1],10));if(n===null){n=undefined}}else{n=this.getPageIndex(t)}if("undefined"!=typeof n){var i=0;var s;this.jumpToIndex(n);e("#BRcontainer").attr("scrollTop",i);return true}return false};BookReader.prototype.jumpToIndex=function(t,n,r){this.willChangeToIndex(t);this.ttsStop();if(this.constMode2up==this.mode){this.autoStop();if(t<Math.min(this.twoPage.currentIndexL,this.twoPage.currentIndexR)){this.flipBackToIndex(t)}else if(t>Math.max(this.twoPage.currentIndexL,this.twoPage.currentIndexR)){this.flipFwdToIndex(t)}}else if(this.constModeThumb==this.mode){var i=e("#BRcontainer").attr("scrollWidth")-20;var s;var o=0;var u=0;var a=0;var f=0;var l=0;var c=0;var h=0;for(s=0;s<t+1;s++){o=this.thumbWidth;if(a+(o+this.thumbPadding)>i){a=0;l=0;h=0}u=parseInt(this.getPageHeight(h)*this.thumbWidth/this.getPageWidth(h),10);if(u>l){l=u}if(h==0){c=f}if(h==0){f+=this.thumbPadding+l}a+=o+this.thumbPadding;h++}this.firstIndex=t;if(e("#BRcontainer").attr("scrollTop")==c){this.loadLeafs()}else{e("#BRcontainer").animate({scrollTop:c},"fast")}}else{var c=this.onePageGetPageTop(t);if(r){var p=parseInt(r/this.reduce);p-=e("#BRcontainer").attr("clientHeight")>>1;c+=p}else{c-=this.padding/2}if(n){var p=parseInt(n/this.reduce);p-=e("#BRcontainer").attr("clientWidth")>>1;leafLeft+=p}else{leafLeft=e("#BRcontainer").scrollLeft()}e("#BRcontainer").animate({scrollTop:c,scrollLeft:leafLeft},"fast")}};BookReader.prototype.switchMode=function(t){if(t==this.mode){return}if(!this.canSwitchToMode(t)){return}this.autoStop();this.ttsStop();this.removeSearchHilites();this.mode=t;if(this.pageScale!=this.reduce){this.reduce=this.pageScale}if(1==t){this.onePageCalculateReductionFactors(e("#BRcontainer").attr("clientWidth"),e("#BRcontainer").attr("clientHeight"));this.reduce=this.quantizeReduce(this.reduce,this.onePage.reductionFactors);this.prepareOnePageView()}else if(3==t){this.reduce=this.quantizeReduce(this.reduce,this.reductionFactors);this.prepareThumbnailView()}else{this.twoPageCalculateReductionFactors();this.reduce=this.quantizeReduce(this.reduce,this.twoPage.reductionFactors);this.prepareTwoPageView();this.twoPageCenterView(.5,.5)}};BookReader.prototype.prepareOnePageView=function(){var t=this.currentIndex();e("#BRcontainer").empty();e("#BRcontainer").css({overflowY:"scroll",overflowX:"auto"});e("#BRcontainer").append("<div id='BRpageview'></div>");e("#BRcontainer").dragscrollable();this.bindGestures(e("#BRcontainer"));this.resizePageView();this.jumpToIndex(t);this.displayedIndices=[];this.drawLeafsOnePage()};BookReader.prototype.prepareThumbnailView=function(){e("#BRcontainer").empty();e("#BRcontainer").css({overflowY:"scroll",overflowX:"auto"});e("#BRcontainer").append("<div id='BRpageview'></div>");e("#BRcontainer").dragscrollable();this.bindGestures(e("#BRcontainer"));this.thumbWidth=this.getThumbnailWidth(this.thumbColumns);this.reduce=this.getPageWidth(0)/this.thumbWidth;this.displayedRows=[];this.drawLeafsThumbnail(this.currentIndex())};BookReader.prototype.prepareTwoPageView=function(t,n){e("#BRcontainer").empty();e("#BRcontainer").css("overflow","auto");var r=this.firstIndex;if(r<this.firstDisplayableIndex()){r=this.firstDisplayableIndex()}if(r>this.lastDisplayableIndex()){r=this.lastDisplayableIndex()}var i=this.getSpreadIndices(r);this.twoPage.currentIndexL=i[0];this.twoPage.currentIndexR=i[1];this.firstIndex=this.twoPage.currentIndexL;this.calculateSpreadSize();this.pruneUnusedImgs();this.prefetch();e("#BRcontainer").append('<div id="BRtwopageview"></div>');this.bindGestures(e("#BRcontainer"));e("#BRtwopageview").css({height:this.twoPage.totalHeight+"px",width:this.twoPage.totalWidth+"px",position:"absolute"});if(this.twoPage.totalWidth<e("#BRcontainer").attr("clientWidth")){t=.5}if(this.twoPage.totalHeight<e("#BRcontainer").attr("clientHeight")){n=.5}this.twoPageCenterView(t,n);this.twoPage.coverDiv=document.createElement("div");e(this.twoPage.coverDiv).attr("id","BRbookcover").css({width:this.twoPage.bookCoverDivWidth+"px",height:this.twoPage.bookCoverDivHeight+"px",visibility:"visible"}).appendTo("#BRtwopageview");this.leafEdgeR=document.createElement("div");this.leafEdgeR.className="BRleafEdgeR";e(this.leafEdgeR).css({width:this.twoPage.leafEdgeWidthR+"px",height:this.twoPage.height+"px",left:this.twoPage.gutter+this.twoPage.scaledWR+"px",top:this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding+"px"}).appendTo("#BRtwopageview");this.leafEdgeL=document.createElement("div");this.leafEdgeL.className="BRleafEdgeL";e(this.leafEdgeL).css({width:this.twoPage.leafEdgeWidthL+"px",height:this.twoPage.height+"px",left:this.twoPage.bookCoverDivLeft+this.twoPage.coverInternalPadding+"px",top:this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding+"px"}).appendTo("#BRtwopageview");div=document.createElement("div");e(div).attr("id","BRgutter").css({width:this.twoPage.bookSpineDivWidth+"px",height:this.twoPage.bookSpineDivHeight+"px",left:this.twoPage.gutter-this.twoPage.bookSpineDivWidth*.5+"px",top:this.twoPage.bookSpineDivTop+"px"}).appendTo("#BRtwopageview");var s=this;this.prepareTwoPagePopUp();this.displayedIndices=[];this.drawLeafsTwoPage();this.updateToolbarZoom(this.reduce);this.prefetch();this.removeSearchHilites();this.updateSearchHilites()};BookReader.prototype.prepareTwoPagePopUp=function(){this.twoPagePopUp=document.createElement("div");this.twoPagePopUp.className="BRtwoPagePopUp";e(this.twoPagePopUp).css({zIndex:"1000"}).appendTo("#BRcontainer");e(this.twoPagePopUp).hide();e(this.leafEdgeL).add(this.leafEdgeR).bind("mouseenter",this,function(t){e(t.data.twoPagePopUp).show()});e(this.leafEdgeL).add(this.leafEdgeR).bind("mouseleave",this,function(t){e(t.data.twoPagePopUp).hide()});e(this.leafEdgeL).bind("click",this,function(e){e.data.autoStop();e.data.ttsStop();var t=e.data.jumpIndexForLeftEdgePageX(e.pageX);e.data.jumpToIndex(t)});e(this.leafEdgeR).bind("click",this,function(e){e.data.autoStop();e.data.ttsStop();var t=e.data.jumpIndexForRightEdgePageX(e.pageX);e.data.jumpToIndex(t)});e(this.leafEdgeR).bind("mousemove",this,function(t){var n=t.data.jumpIndexForRightEdgePageX(t.pageX);e(t.data.twoPagePopUp).text("View "+t.data.getPageName(n));e(t.data.twoPagePopUp).css({left:t.pageX-e("#BRcontainer").offset().left+e("#BRcontainer").scrollLeft()-100+"px",top:t.pageY-e("#BRcontainer").offset().top+e("#BRcontainer").scrollTop()+"px"})});e(this.leafEdgeL).bind("mousemove",this,function(t){var n=t.data.jumpIndexForLeftEdgePageX(t.pageX);e(t.data.twoPagePopUp).text("View "+t.data.getPageName(n));e(t.data.twoPagePopUp).css({left:t.pageX-e("#BRcontainer").offset().left+e("#BRcontainer").scrollLeft()-e(t.data.twoPagePopUp).width()+100+"px",top:t.pageY-e("#BRcontainer").offset().top+e("#BRcontainer").scrollTop()+"px"})})};BookReader.prototype.calculateSpreadSize=function(){var e=this.twoPage.currentIndexL;var t=this.twoPage.currentIndexR;var n;if(this.twoPage.autofit){n=this.getIdealSpreadSize(e,t)}else{n=this.getSpreadSizeFromReduce(e,t,this.reduce)}this.twoPage.height=n.height;this.twoPage.width=n.width;this.twoPage.scaledWL=this.getPageWidth2UP(e);this.twoPage.scaledWR=this.getPageWidth2UP(t);this.twoPage.edgeWidth=n.totalLeafEdgeWidth;this.twoPage.leafEdgeWidthL=this.leafEdgeWidth(this.twoPage.currentIndexL);this.twoPage.leafEdgeWidthR=this.twoPage.edgeWidth-this.twoPage.leafEdgeWidthL;this.twoPage.bookCoverDivWidth=this.twoPageCoverWidth(this.twoPage.scaledWL+this.twoPage.scaledWR);this.twoPage.bookCoverDivHeight=this.twoPage.height+2*this.twoPage.coverInternalPadding;var r=this.gutterOffsetForIndex(e);var i=this.twoPage.scaledWL-r+this.twoPage.leafEdgeWidthL;var s=this.twoPage.scaledWR+r+this.twoPage.leafEdgeWidthR;var o=Math.max(i,s);this.twoPage.totalWidth=2*(o+this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);this.twoPage.totalHeight=this.twoPage.height+2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);this.twoPage.middle=this.twoPage.totalWidth>>1;this.twoPage.gutter=this.twoPage.middle+this.gutterOffsetForIndex(e);this.twoPage.bookCoverDivLeft=this.twoPage.gutter-this.twoPage.scaledWL-this.twoPage.leafEdgeWidthL-this.twoPage.coverInternalPadding;this.twoPage.bookCoverDivTop=this.twoPage.coverExternalPadding;this.twoPage.bookSpineDivHeight=this.twoPage.height+2*this.twoPage.coverInternalPadding;this.twoPage.bookSpineDivLeft=this.twoPage.middle-(this.twoPage.bookSpineDivWidth>>1);this.twoPage.bookSpineDivTop=this.twoPage.bookCoverDivTop;this.reduce=n.reduce};BookReader.prototype.getIdealSpreadSize=function(t,n){var r={};var i=1.5;var s={height:this._getPageHeight(t),width:this._getPageWidth(t)};var o={height:this._getPageHeight(n),width:this._getPageWidth(n)};var u=s.height/s.width;var a=o.height/o.width;var f;if(Math.abs(u-i)<Math.abs(a-i)){f=u}else{f=a}var l=parseInt(this.numLeafs*.1);var c=parseInt(e("#BRcontainer").attr("clientWidth")*.1);r.totalLeafEdgeWidth=Math.min(l,c);var h=2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding)+r.totalLeafEdgeWidth;var p=2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);r.width=e("#BRcontainer").width()-h>>1;r.width-=10;r.height=e("#BRcontainer").height()-p;r.height-=20;if(r.height/f<=r.width){r.width=parseInt(r.height/f)}else{r.height=parseInt(r.width*f)}r.reduce=(s.height+o.height)/2/r.height;return r};BookReader.prototype.getSpreadSizeFromReduce=function(t,n,r){var i={};var s=parseInt(this.numLeafs*.1);var o=parseInt(e("#BRcontainer").attr("clientWidth")*.1);i.totalLeafEdgeWidth=Math.min(s,o);var u=this._getPageWidth(t)+this._getPageWidth(n);var a=this._getPageHeight(t)+this._getPageHeight(n);i.height=parseInt(a/2/this.reduce);i.width=parseInt(u/2/this.reduce);i.reduce=r;return i};BookReader.prototype.twoPageGetAutofitReduce=function(){var e=this.getIdealSpreadSize(this.twoPage.currentIndexL,this.twoPage.currentIndexR);return e.reduce};BookReader.prototype.twoPageIsZoomedIn=function(){var e=this.twoPageGetAutofitReduce();var t=false;if(this.twoPage.autofit!="auto"){if(this.reduce<this.twoPageGetAutofitReduce()){t=true}}return t};BookReader.prototype.onePageGetAutofitWidth=function(){var t=20;return(this.getMedianPageSize().width+0)/(e("#BRcontainer").attr("clientWidth")-t*2)};BookReader.prototype.onePageGetAutofitHeight=function(){return(this.getMedianPageSize().height+0)/(e("#BRcontainer").attr("clientHeight")-this.padding*2)};BookReader.prototype.onePageGetPageTop=function(e){var t;var n=0;var r=0;var i;for(t=0;t<e;t++){i=parseInt(this._getPageHeight(t)/this.reduce);n+=i+this.padding}return n};BookReader.prototype.getMedianPageSize=function(){if(this._medianPageSize){return this._medianPageSize}var e=[];var t=[];for(var n=0;n<this.numLeafs;n++){e.push(this.getPageWidth(n));t.push(this.getPageHeight(n))}e.sort();t.sort();this._medianPageSize={width:e[parseInt(e.length/2)],height:t[parseInt(t.length/2)]};return this._medianPageSize};BookReader.prototype.onePageCalculateReductionFactors=function(e,t){this.onePage.reductionFactors=this.reductionFactors.concat([{reduce:this.onePageGetAutofitWidth(),autofit:"width"},{reduce:this.onePageGetAutofitHeight(),autofit:"height"}]);this.onePage.reductionFactors.sort(this._reduceSort)};BookReader.prototype.twoPageCalculateReductionFactors=function(){this.twoPage.reductionFactors=this.reductionFactors.concat([{reduce:this.getIdealSpreadSize(this.twoPage.currentIndexL,this.twoPage.currentIndexR).reduce,autofit:"auto"}]);this.twoPage.reductionFactors.sort(this._reduceSort)};BookReader.prototype.twoPageSetCursor=function(){if(e("#BRtwopageview").width()>e("#BRcontainer").attr("clientWidth")||e("#BRtwopageview").height()>e("#BRcontainer").attr("clientHeight")){e(this.prefetchedImgs[this.twoPage.currentIndexL]).css("cursor","move");e(this.prefetchedImgs[this.twoPage.currentIndexR]).css("cursor","move")}else{e(this.prefetchedImgs[this.twoPage.currentIndexL]).css("cursor","");e(this.prefetchedImgs[this.twoPage.currentIndexR]).css("cursor","")}};BookReader.prototype.currentIndex=function(){if(this.mode==this.constMode1up||this.mode==this.constModeThumb){return this.firstIndex}else if(this.mode==this.constMode2up){return BookReader.util.clamp(this.firstIndex,0,this.numLeafs-1)}else{throw"currentIndex called for unimplemented mode "+this.mode}};BookReader.prototype.setCurrentIndex=function(e){this.firstIndex=e};BookReader.prototype.right=function(){if("rl"!=this.pageProgression){this.next()}else{this.prev()}};BookReader.prototype.rightmost=function(){if("rl"!=this.pageProgression){this.last()}else{this.first()}};BookReader.prototype.left=function(){if("rl"!=this.pageProgression){this.prev()}else{this.next()}};BookReader.prototype.leftmost=function(){if("rl"!=this.pageProgression){this.first()}else{this.last()}};BookReader.prototype.next=function(){if(2==this.mode){this.autoStop();this.flipFwdToIndex(null)}else{if(this.firstIndex<this.lastDisplayableIndex()){this.jumpToIndex(this.firstIndex+1)}}};BookReader.prototype.prev=function(){if(2==this.mode){this.autoStop();this.flipBackToIndex(null)}else{if(this.firstIndex>=1){this.jumpToIndex(this.firstIndex-1)}}};BookReader.prototype.first=function(){this.jumpToIndex(this.firstDisplayableIndex())};BookReader.prototype.last=function(){this.jumpToIndex(this.lastDisplayableIndex())};BookReader.prototype.scrollDown=function(){if(e.inArray(this.mode,[this.constMode1up,this.constModeThumb])>=0){if(this.mode==this.constMode1up&&this.reduce>=this.onePageGetAutofitHeight()){return this.next()}e("#BRcontainer").animate({scrollTop:"+="+this._scrollAmount()+"px"},400,"easeInOutExpo");return true}else{return false}};BookReader.prototype.scrollUp=function(){if(e.inArray(this.mode,[this.constMode1up,this.constModeThumb])>=0){if(this.mode==this.constMode1up&&this.reduce>=this.onePageGetAutofitHeight()){return this.prev()}e("#BRcontainer").animate({scrollTop:"-="+this._scrollAmount()+"px"},400,"easeInOutExpo");return true}else{return false}};BookReader.prototype._scrollAmount=function(){if(this.constMode1up==this.mode){return parseInt(e("#BRcontainer").attr("clientHeight")-this.getPageHeight(this.currentIndex())/this.reduce*.03)}return parseInt(.9*e("#BRcontainer").attr("clientHeight"))};BookReader.prototype.flipBackToIndex=function(e){if(1==this.mode)return;var t=this.twoPage.currentIndexL;if(this.animating)return;if(null!=this.leafEdgeTmp){alert("error: leafEdgeTmp should be null!");return}if(null==e){e=t-2}this.willChangeToIndex(e);var n=this.getSpreadIndices(e);if(n[0]<this.firstDisplayableIndex()||n[1]<this.firstDisplayableIndex()){return}this.animating=true;if("rl"!=this.pageProgression){this.prepareFlipLeftToRight(n[0],n[1]);this.flipLeftToRight(n[0],n[1])}else{var r=this.prepareFlipRightToLeft(n[0],n[1]);this.flipRightToLeft(n[0],n[1],r)}};BookReader.prototype.flipLeftToRight=function(t,n){var r=this.twoPage.currentIndexL;var i=this.leafEdgeWidth(this.twoPage.currentIndexL);var s=this.leafEdgeWidth(t);var o=i-s;var u=this.getPageWidth2UP(r);var a=this.getPageWidth2UP(t);var f=this.getPageWidth2UP(n);var l=this.twoPageTop();var c=this.twoPage.middle+this.gutterOffsetForIndex(t);var h=c-u-o;this.leafEdgeTmp=document.createElement("div");this.leafEdgeTmp.className="BRleafEdgeTmp";e(this.leafEdgeTmp).css({width:o+"px",height:this.twoPage.height+"px",left:h+"px",top:l+"px",zIndex:1e3}).appendTo("#BRtwopageview");e(this.leafEdgeL).css({width:s+"px",left:c-u-s+"px"});var p=e(this.prefetchedImgs[r]).offset().left;var d=e("#BRtwopageview").attr("clientWidth")-p-e(this.prefetchedImgs[r]).width()+e("#BRtwopageview").offset().left-2+"px";e(this.prefetchedImgs[r]).css({right:d,left:""});e(this.leafEdgeTmp).animate({left:c},this.flipSpeed,"easeInSine");var v=this;this.removeSearchHilites();e(this.prefetchedImgs[r]).animate({width:"0px"},v.flipSpeed,"easeInSine",function(){e(v.leafEdgeTmp).animate({left:c+f+"px"},v.flipSpeed,"easeOutSine");e("#BRgutter").css({left:c-v.twoPage.bookSpineDivWidth*.5+"px"});e(v.prefetchedImgs[n]).animate({width:f+"px"},v.flipSpeed,"easeOutSine",function(){e(v.prefetchedImgs[t]).css("zIndex",2);e(v.prefetchedImgs[t]).css("display","");e(v.prefetchedImgs[n]).css("display","");e(v.leafEdgeR).css({width:v.twoPage.edgeWidth-s+"px",left:c+f+"px"});e(v.leafEdgeL).css({width:s+"px",left:c-a-s+"px"});e(v.twoPage.coverDiv).css({width:v.twoPageCoverWidth(a+f)+"px",left:c-a-s-v.twoPage.coverInternalPadding+"px"});e(v.leafEdgeTmp).remove();v.leafEdgeTmp=null;v.twoPage.currentIndexL=t;v.twoPage.currentIndexR=n;v.twoPage.scaledWL=a;v.twoPage.scaledWR=f;v.twoPage.gutter=c;v.firstIndex=v.twoPage.currentIndexL;v.displayedIndices=[t,n];v.pruneUnusedImgs();v.prefetch();v.animating=false;v.updateSearchHilites2UP();v.updatePageNumBox2UP();v.setMouseHandlers2UP();v.twoPageSetCursor();if(v.animationFinishedCallback){v.animationFinishedCallback();v.animationFinishedCallback=null}})})};BookReader.prototype.flipFwdToIndex=function(e){if(this.animating)return;if(null!=this.leafEdgeTmp){alert("error: leafEdgeTmp should be null!");return}if(null==e){e=this.twoPage.currentIndexR+2}if(e>this.lastDisplayableIndex())return;this.willChangeToIndex(e);this.animating=true;var t=this.getSpreadIndices(e);if("rl"!=this.pageProgression){var n=this.prepareFlipRightToLeft(t[0],t[1]);this.flipRightToLeft(t[0],t[1],n)}else{var n=this.prepareFlipLeftToRight(t[0],t[1]);this.flipLeftToRight(t[0],t[1])}};BookReader.prototype.willChangeToIndex=function(e){this.updateNavIndex(e)};BookReader.prototype.flipRightToLeft=function(t,n){var r=this.leafEdgeWidth(this.twoPage.currentIndexL);var i=this.twoPage.edgeWidth-r;var s=this.leafEdgeWidth(t);var o=this.twoPage.edgeWidth-s;var u=i-o;var a=this.twoPageTop();var f=this.getPageWidth2UP(this.twoPage.currentIndexR);var l=this.twoPage.middle;var c=l+this.gutterOffsetForIndex(t);this.leafEdgeTmp=document.createElement("div");this.leafEdgeTmp.className="BRleafEdgeTmp";e(this.leafEdgeTmp).css({width:u+"px",height:this.twoPage.height+"px",left:c+f+"px",top:a+"px",zIndex:1e3}).appendTo("#BRtwopageview");var h=this.getPageWidth2UP(this.twoPage.currentIndexL);var p=this.getPageWidth2UP(this.twoPage.currentIndexR);var d=this.getPageWidth2UP(t);var v=this.getPageWidth2UP(n);e(this.leafEdgeR).css({width:o+"px",left:c+v+"px"});var m=this;var g=this.flipSpeed;this.removeSearchHilites();e(this.leafEdgeTmp).animate({left:c},g,"easeInSine");e(this.prefetchedImgs[this.twoPage.currentIndexR]).animate({width:"0px"},g,"easeInSine",function(){e("#BRgutter").css({left:c-m.twoPage.bookSpineDivWidth*.5+"px"});e(m.leafEdgeTmp).animate({left:c-d-u+"px"},g,"easeOutSine");e(m.prefetchedImgs[t]).animate({width:d+"px"},g,"easeOutSine",function(){e(m.prefetchedImgs[n]).css("zIndex",2);e(m.prefetchedImgs[t]).css("display","");e(m.prefetchedImgs[n]).css("display","");e(m.leafEdgeL).css({width:s+"px",left:c-d-s+"px"});e(m.twoPage.coverDiv).css({width:m.twoPageCoverWidth(d+v)+"px",left:c-d-s-m.twoPage.coverInternalPadding+"px"});e(m.leafEdgeTmp).remove();m.leafEdgeTmp=null;m.twoPage.currentIndexL=t;m.twoPage.currentIndexR=n;m.twoPage.scaledWL=d;m.twoPage.scaledWR=v;m.twoPage.gutter=c;m.firstIndex=m.twoPage.currentIndexL;m.displayedIndices=[t,n];m.pruneUnusedImgs();m.prefetch();m.animating=false;m.updateSearchHilites2UP();m.updatePageNumBox2UP();m.setMouseHandlers2UP();m.twoPageSetCursor();if(m.animationFinishedCallback){m.animationFinishedCallback();m.animationFinishedCallback=null}})})};BookReader.prototype.setMouseHandlers2UP=function(){this.setClickHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexL],{self:this},function(e){if(e.which==3){if(e.data.self.protected){return false}return true}if(!e.data.self.twoPageIsZoomedIn()){e.data.self.ttsStop();e.data.self.left()}e.preventDefault()});this.setClickHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexR],{self:this},function(e){if(e.which==3){if(e.data.self.protected){return false}return true}if(!e.data.self.twoPageIsZoomedIn()){e.data.self.ttsStop();e.data.self.right()}e.preventDefault()})};BookReader.prototype.prefetchImg=function(t){var n=this._getPageURI(t);var r=false;if(undefined==this.prefetchedImgs[t]){r=true}else if(n!=this.prefetchedImgs[t].uri){r=true}if(r){var i=document.createElement("img");e(i).addClass("BRpageimage").addClass("BRnoselect");if(t<0||t>this.numLeafs-1){e(i).css({"background-color":"#efefef"})}i.src=n;i.uri=n;this.prefetchedImgs[t]=i}};BookReader.prototype.prepareFlipLeftToRight=function(t,n){this.prefetchImg(t);this.prefetchImg(n);var r=this._getPageHeight(t);var i=this._getPageWidth(t);var s=this.twoPage.middle;var o=this.twoPageTop();var u=this.twoPage.height*i/r;var a=s+this.gutterOffsetForIndex(t);var f={position:"absolute",left:a-u+"px",right:"",top:o+"px",height:this.twoPage.height,width:u+"px",zIndex:1};e(this.prefetchedImgs[t]).css(f);e("#BRtwopageview").append(this.prefetchedImgs[t]);var l={position:"absolute",left:a+"px",right:"",top:o+"px",height:this.twoPage.height,width:"0",zIndex:2};e(this.prefetchedImgs[n]).css(l);e("#BRtwopageview").append(this.prefetchedImgs[n])};BookReader.prototype.prepareFlipRightToLeft=function(t,n){this.prefetchImg(t);this.prefetchImg(n);var r=this._getPageHeight(n);var i=this._getPageWidth(n);var s=this.twoPage.middle;var o=this.twoPageTop();var u=this.twoPage.height*i/r;var a=s+this.gutterOffsetForIndex(t);e(this.prefetchedImgs[n]).css({position:"absolute",left:a+"px",top:o+"px",height:this.twoPage.height,width:u+"px",zIndex:1});e("#BRtwopageview").append(this.prefetchedImgs[n]);r=this._getPageHeight(t);i=this._getPageWidth(t);u=this.twoPage.height*i/r;e(this.prefetchedImgs[t]).css({position:"absolute",right:e("#BRtwopageview").attr("clientWidth")-a+"px",top:o+"px",height:this.twoPage.height,width:0+"px",zIndex:2});e("#BRtwopageview").append(this.prefetchedImgs[t])};BookReader.prototype.pruneUnusedImgs=function(){for(var t in this.prefetchedImgs){if(t!=this.twoPage.currentIndexL&&t!=this.twoPage.currentIndexR){e(this.prefetchedImgs[t]).remove()}if(t<this.twoPage.currentIndexL-4||t>this.twoPage.currentIndexR+4){delete this.prefetchedImgs[t]}}};BookReader.prototype.prefetch=function(){this.prefetchImg(this.twoPage.currentIndexL);this.prefetchImg(this.twoPage.currentIndexR);var e=3;var t=Math.min(this.twoPage.currentIndexL,this.twoPage.currentIndexR);var n=Math.max(this.twoPage.currentIndexL,this.twoPage.currentIndexR);var r=Math.max(t-e,0);var i=Math.min(n+e,this.numLeafs-1);for(var s=1;s<=e;s++){var o=t-s;if(o>=r){this.prefetchImg(o)}var u=n+s;if(u<=i){this.prefetchImg(u)}}};BookReader.prototype.getPageWidth2UP=function(e){var t=this._getPageHeight(e);var n=this._getPageWidth(e);return Math.floor(this.twoPage.height*n/t)};BookReader.prototype.search=function(t){e("#textSrch").blur();var n="http://"+this.server.replace(/:.+/,"");n+="/fulltext/inside.php?item_id="+this.bookId;n+="&doc="+this.subPrefix;n+="&path="+this.bookPath.replace(new RegExp("/"+this.subPrefix+"$"),"");n+="&q="+escape(t);t=t.replace(/\//g," ");this.searchTerm=t;this.removeSearchResults();this.showProgressPopup('<img id="searchmarker" src="'+this.imagesBaseURL+"marker_srch-on.png"+'"> Search results will appear below...');e.ajax({url:n,dataType:"jsonp",jsonpCallback:"br.BRSearchCallback"})};BookReader.prototype.BRSearchCallback=function(t){br.removeSearchResults();br.searchResults=t;if(0==t.matches.length){var n="No matches were found.";var r=1e3;if(false===t.indexed){n="<p>This book hasn't been indexed for searching yet. We've just started indexing it, so search should be available soon. Please try again later. Thanks!</p>";r=5e3}e(br.popup).html(n);setTimeout(function(){e(br.popup).fadeOut("slow",function(){br.removeProgressPopup()})},r);return}var i;for(i=0;i<t.matches.length;i++){br.addSearchResult(t.matches[i].text,br.leafNumToIndex(t.matches[i].par[0].page))}br.updateSearchHilites();br.removeProgressPopup()};BookReader.prototype.updateSearchHilites=function(){if(2==this.mode){this.updateSearchHilites2UP()}else{this.updateSearchHilites1UP()}};BookReader.prototype.updateSearchHilites1UP=function(){var t=this.searchResults;if(null==t)return;var n,r;for(n=0;n<t.matches.length;n++){for(r=0;r<t.matches[n].par[0].boxes.length;r++){var i=t.matches[n].par[0].boxes[r];var s=this.leafNumToIndex(i.page);if(jQuery.inArray(s,this.displayedIndices)>=0){if(null==i.div){i.div=document.createElement("div");e(i.div).attr("className","BookReaderSearchHilite").appendTo("#pagediv"+s)}e(i.div).css({width:(i.r-i.l)/this.reduce+"px",height:(i.b-i.t)/this.reduce+"px",left:i.l/this.reduce+"px",top:i.t/this.reduce+"px"})}else{if(null!=i.div){e(i.div).remove();i.div=null}}}}};BookReader.prototype.twoPageGutter=function(){return this.twoPage.middle+this.gutterOffsetForIndex(this.twoPage.currentIndexL)};BookReader.prototype.twoPageTop=function(){return this.twoPage.coverExternalPadding+this.twoPage.coverInternalPadding};BookReader.prototype.twoPageCoverWidth=function(e){return e+this.twoPage.edgeWidth+2*this.twoPage.coverInternalPadding};BookReader.prototype.twoPageGetViewCenter=function(){var t={};var n=e("#BRcontainer").offset();var r=e("#BRtwopageview").offset();t.percentageX=(n.left-r.left+(e("#BRcontainer").attr("clientWidth")>>1))/this.twoPage.totalWidth;t.percentageY=(n.top-r.top+(e("#BRcontainer").attr("clientHeight")>>1))/this.twoPage.totalHeight;return t};BookReader.prototype.twoPageCenterView=function(t,n){if("undefined"==typeof t){t=.5}if("undefined"==typeof n){n=.5}var r=e("#BRtwopageview").width();var i=e("#BRcontainer").attr("clientWidth");var s=t*r;var o=e("#BRtwopageview").height();var u=e("#BRcontainer").attr("clientHeight");var a=n*o;if(r<i){e("#BRtwopageview").css("left",(i>>1)-s+"px")}else{e("#BRtwopageview").css("left",0);e("#BRcontainer").scrollLeft(s-(i>>1))}if(o<u){e("#BRtwopageview").css("top",(u>>1)-a+"px")}else{e("#BRtwopageview").css("top",0);e("#BRcontainer").scrollTop(a-(u>>1))}};BookReader.prototype.twoPageFlipAreaHeight=function(){return parseInt(this.twoPage.height)};BookReader.prototype.twoPageFlipAreaWidth=function(){var e=100;var t=10;var n=this.twoPage.width*.15;return parseInt(BookReader.util.clamp(n,t,e))};BookReader.prototype.twoPageFlipAreaTop=function(){return parseInt(this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding)};BookReader.prototype.twoPageLeftFlipAreaLeft=function(){return parseInt(this.twoPage.gutter-this.twoPage.scaledWL)};BookReader.prototype.twoPageRightFlipAreaLeft=function(){return parseInt(this.twoPage.gutter+this.twoPage.scaledWR-this.twoPageFlipAreaWidth())};BookReader.prototype.twoPagePlaceFlipAreas=function(){e(this.twoPage.leftFlipArea).css({left:this.twoPageLeftFlipAreaLeft()+"px",width:this.twoPageFlipAreaWidth()+"px"});e(this.twoPage.rightFlipArea).css({left:this.twoPageRightFlipAreaLeft()+"px",width:this.twoPageFlipAreaWidth()+"px"})};BookReader.prototype.updateSearchHilites2UP=function(){var t=this.searchResults;if(null==t)return;var n,r;for(n=0;n<t.matches.length;n++){var i=this.leafNumToIndex(t.matches[n].par[0].page);for(r=0;r<t.matches[n].par[0].boxes.length;r++){var s=t.matches[n].par[0].boxes[r];if(jQuery.inArray(i,this.displayedIndices)>=0){if(null==s.div){s.div=document.createElement("div");e(s.div).attr("className","BookReaderSearchHilite").css("zIndex",3).appendTo("#BRtwopageview")}this.setHilightCss2UP(s.div,i,s.l,s.r,s.t,s.b)}else{if(null!=s.div){e(s.div).remove();s.div=null}}}}};BookReader.prototype.setHilightCss2UP=function(t,n,r,i,s,o){var u=this._getPageHeight(n);var a=this._getPageWidth(n);var f=this.twoPage.height/u;var l=parseInt(a*f);var c=this.twoPageGutter();var h;if("L"==this.getPageSide(n)){h=c-l}else{h=c}var p=this.twoPageTop();e(t).css({width:(i-r)*f+"px",height:(o-s)*f+"px",left:h+r*f+"px",top:p+s*f+"px"})};BookReader.prototype.removeSearchHilites=function(){var t=this.searchResults;if(null==t)return;var n,r;for(n=0;n<t.matches.length;n++){for(r=0;r<t.matches[n].par[0].boxes.length;r++){var i=t.matches[n].par[0].boxes[r];if(null!=i.div){e(i.div).remove();i.div=null}}}};BookReader.prototype.printPage=function(){window.open(this.getPrintURI(),"printpage","width=400, height=500, resizable=yes, scrollbars=no, toolbar=no, location=no")};BookReader.prototype.getPrintURI=function(){var e;if(this.constMode2up==this.mode){e=this.twoPage.currentIndexL}else{e=this.firstIndex}var t="id="+this.subPrefix+"&server="+this.server+"&zip="+this.zip+"&format="+this.imageFormat+"&file="+this._getPageFile(e)+"&width="+this._getPageWidth(e)+"&height="+this._getPageHeight(e);if(this.constMode2up==this.mode){t+="&file2="+this._getPageFile(this.twoPage.currentIndexR)+"&width2="+this._getPageWidth(this.twoPage.currentIndexR);t+="&height2="+this._getPageHeight(this.twoPage.currentIndexR);t+="&title="+encodeURIComponent(this.shortTitle(50)+" - Pages "+this.getPageNum(this.twoPage.currentIndexL)+", "+this.getPageNum(this.twoPage.currentIndexR))}else{t+="&title="+encodeURIComponent(this.shortTitle(50)+" - Page "+this.getPageNum(e))}return"/bookreader/print.php?"+t};BookReader.prototype.showEmbedCode=function(){if(null!=this.embedPopup){return}this.autoStop();this.ttsStop();this.embedPopup=document.createElement("div");e(this.embedPopup).css({position:"absolute",top:(e("#BRcontainer").attr("clientHeight")-250)/2+"px",left:(e("#BRcontainer").attr("clientWidth")-400)/2+"px",width:"400px",height:"250px",padding:"0",fontSize:"12px",color:"#333",zIndex:300,border:"10px solid #615132",backgroundColor:"#fff",MozBorderRadius:"8px",MozBoxShadow:"0 0 6px #000",WebkitBorderRadius:"8px",WebkitBoxShadow:"0 0 6px #000"}).appendTo("#BookReader");htmlStr='<h3 style="background:#615132;padding:10px;margin:0 0 10px;color:#fff;">Embed Bookreader</h3>';htmlStr+='<p style="padding:10px;line-height:18px;">The bookreader uses iframes for embedding. It will not work on web hosts that block iframes. The embed feature has been tested on blogspot.com blogs as well as self-hosted Wordpress blogs. This feature will NOT work on wordpress.com blogs.</p>';htmlStr+='<textarea rows="2" cols="40" style="margin-left:10px;width:368px;height:40px;color:#333;font-size:12px;border:2px inset #ccc;background:#efefef;padding:2px;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;">'+this.getEmbedCode()+"</textarea>";htmlStr+='<a href="javascript:;" class="popOff" onclick="$(this.parentNode).remove();$(\'.coverUp\').hide();return false" style="color:#999;"><span>Close</span></a>';this.embedPopup.innerHTML=htmlStr;e("#BookReader").append('<div class="coverUp" style="position:absolute;z-index:299;width:100%;height:100%;background:#000;opacity:.4;filter:alpha(opacity=40);" onclick="$(\'.popped\').hide();$(this).hide();"></div>');e(this.embedPopup).find("textarea").click(function(){this.select()});e(this.embedPopup).addClass("popped")};BookReader.prototype.showBookmarkCode=function(){this.bookmarkPopup=document.createElement("div");e(this.bookmarkPopup).css({position:"absolute",top:(e("#BRcontainer").attr("clientHeight")-250)/2+"px",left:(e("#BRcontainer").attr("clientWidth")-400)/2+"px",width:"400px",height:"250px",padding:"0",fontSize:"12px",color:"#333",zIndex:300,border:"10px solid #615132",backgroundColor:"#fff",MozBorderRadius:"8px",MozBoxShadow:"0 0 6px #000",WebkitBorderRadius:"8px",WebkitBoxShadow:"0 0 6px #000"}).appendTo("#BookReader");htmlStr='<h3 style="background:#615132;padding:10px;margin:0 0 10px;color:#fff;">Add a bookmark</h3>';htmlStr+='<p style="padding:10px;line-height:18px;">You can add a bookmark to any page in any book. If you elect to make your bookmark public, other readers will be able to see it. <em>You must be logged in to your <a href="">Open Library account</a> to add bookmarks.</em></p>';htmlStr+='<form name="bookmark" id="bookmark" style="line-height:20px;margin-left:10px;"><label style="padding-bottom"10px;><input type="radio" name="privacy" id="p2" disabled="disabled" checked="checked"/> Make this bookmark public.</label><br/><label style="padding-bottom:10px;"><input type="radio" name="privacy" id="p1" disabled="disabled"/> Keep this bookmark private.</label><br/><br/><button type="submit" style="font-size:20px;" disabled="disabled">Add a bookmark</button></form>';htmlStr+='<a href="javascript:;" class="popOff" onclick="$(this.parentNode).remove();$(\'.coverUp\').hide();return false;" style="color:#999;"><span>Close</span></a>';this.bookmarkPopup.innerHTML=htmlStr;e("#BookReader").append('<div class="coverUp" style="position:absolute;z-index:299;width:100%;height:100%;background:#000;opacity:.4;filter:alpha(opacity=40);" onclick="$(\'.popped\').hide();$(this).hide();"></div>');e(this.bookmarkPopup).find("textarea").click(function(){this.select()});e(this.bookmarkPopup).addClass("popped")};BookReader.prototype.autoToggle=function(){this.ttsStop();var t=false;if(2!=this.mode){t=true;this.switchMode(2)}if(this.reduce<this.twoPageGetAutofitReduce()){this.zoom2up("auto")}var n=this;if(null==this.autoTimer){this.flipSpeed=2e3;if("rl"==this.pageProgression&&t){}else{this.flipFwdToIndex()}e("#BRtoolbar .play").hide();e("#BRtoolbar .pause").show();this.autoTimer=setInterval(function(){if(n.animating){return}if(Math.max(n.twoPage.currentIndexL,n.twoPage.currentIndexR)>=n.lastDisplayableIndex()){n.flipBackToIndex(1)}else{n.flipFwdToIndex()}},5e3)}else{this.autoStop()}};BookReader.prototype.autoStop=function(){if(null!=this.autoTimer){clearInterval(this.autoTimer);this.flipSpeed="fast";e("#BRtoolbar .pause").hide();e("#BRtoolbar .play").show();this.autoTimer=null}};BookReader.prototype.stopFlipAnimations=function(){this.autoStop();if(this.leafEdgeTmp){e(this.leafEdgeTmp).stop(false,true)}jQuery.each(this.prefetchedImgs,function(){e(this).stop(false,true)});if(this.leafEdgeTmp){e(this.leafEdgeTmp).stop(false,true)}jQuery.each(this.prefetchedImgs,function(){e(this).stop(false,true)})};BookReader.prototype.keyboardNavigationIsDisabled=function(e){if(e.target.tagName=="INPUT"){return true}return false};BookReader.prototype.gutterOffsetForIndex=function(e){var t=parseInt((e/this.numLeafs-.5)*this.twoPage.edgeWidth);if("rl"==this.pageProgression){t=-t}return t};BookReader.prototype.leafEdgeWidth=function(e){if(this.getPageSide(e)=="L"&&this.pageProgression!="rl"){return parseInt(e/this.numLeafs*this.twoPage.edgeWidth+.5)}else{return parseInt((1-e/this.numLeafs)*this.twoPage.edgeWidth+.5)}};BookReader.prototype.jumpIndexForLeftEdgePageX=function(t){if("rl"!=this.pageProgression){var n=this.twoPage.currentIndexL-(e(this.leafEdgeL).offset().left+e(this.leafEdgeL).width()-t)*10;n=BookReader.util.clamp(Math.round(n),this.firstDisplayableIndex(),this.twoPage.currentIndexL-2);return n}else{var n=this.twoPage.currentIndexL+(e(this.leafEdgeL).offset().left+e(this.leafEdgeL).width()-t)*10;n=BookReader.util.clamp(Math.round(n),this.twoPage.currentIndexL+2,this.lastDisplayableIndex());return n}};BookReader.prototype.jumpIndexForRightEdgePageX=function(t){if("rl"!=this.pageProgression){var n=this.twoPage.currentIndexR+(t-e(this.leafEdgeR).offset().left)*10;n=BookReader.util.clamp(Math.round(n),this.twoPage.currentIndexR+2,this.lastDisplayableIndex());return n}else{var n=this.twoPage.currentIndexR-(t-e(this.leafEdgeR).offset().left)*10;n=BookReader.util.clamp(Math.round(n),this.firstDisplayableIndex(),this.twoPage.currentIndexR-2);return n}};BookReader.prototype.initNavbar=function(){e("#BookReader").append('<div id="BRnav">'+'<div id="BRpage">'+'<button class="BRicon onepg"></button>'+'<button class="BRicon twopg"></button>'+'<button class="BRicon thumb"></button>'+'<button class="BRicon zoom_in"></button>'+'<button class="BRicon zoom_out"></button>'+'<button class="BRicon book_left"></button>'+'<button class="BRicon book_right"></button>'+"</div>"+'<div id="BRnavpos">'+'<div id="BRpager"></div>'+'<div id="BRnavline">'+'<div class="BRnavend" id="BRnavleft"></div>'+'<div class="BRnavend" id="BRnavright"></div>'+"</div>"+"</div>"+'<div id="BRnavCntlBtm" class="BRnavCntl BRdn"></div>'+"</div>");var t=this;e("#BRpager").slider({animate:true,min:0,max:this.numLeafs-1,value:this.currentIndex()}).bind("slide",function(n,r){t.updateNavPageNum(r.value);e("#pagenum").show();return true}).bind("slidechange",function(n,r){t.updateNavPageNum(r.value);e("#pagenum").hide();if(e(this).data("swallowchange")){e(this).data("swallowchange",false)}else{t.jumpToIndex(r.value)}return true}).hover(function(){e("#pagenum").show()},function(){e("#pagenum").hide()});var n=e("#BRpager .ui-slider-handle").append('<div id="pagenum"><span class="currentpage"></span></div>');this.updateNavPageNum(this.currentIndex());e("#BRzoombtn").draggable({axis:"y",containment:"parent"})};BookReader.prototype.initEmbedNavbar=function(){var t=(window.location+"").replace("?ui=embed","");e("#BookReader").append('<div id="BRnav">'+"<span id='BRtoolbarbuttons'>"+'<button class="BRicon full"></button>'+'<button class="BRicon book_left"></button>'+'<button class="BRicon book_right"></button>'+"</span>"+"<span><a class='logo' href='"+this.logoURL+"' 'target='_blank' ></a></span>"+"<span id='BRembedreturn'><a href='"+t+"' target='_blank' ></a></span>"+"</div>");e("#BRembedreturn a").text(this.bookTitle)};BookReader.prototype.updateNavPageNum=function(t){var n=this.getPageNum(t);var r;if(n[0]=="n"){r=t+1+" / "+this.numLeafs}else{r="Page "+n}e("#pagenum .currentpage").text(r)};BookReader.prototype.updateNavIndex=function(t){e("#BRpager").data("swallowchange",true).slider("value",t)};BookReader.prototype.addSearchResult=function(t,n){var r=this.getPageNum(n);var i="Search result";var s="Page";var o=BookReader.util.cssPercentage(n,this.numLeafs-1);var u="";if(r){u=s+" "+r}var a=new RegExp("{{{(.+?)}}}","g");t=t.replace(a,'<a href="#" onclick="br.jumpToIndex('+n+'); return false;">$1</a>');var f=e('<div class="search" style="top:'+ -e("#BRcontainer").height()+"px; left:"+o+';" title="'+i+'"><div class="query">'+t+"<span>"+s+" "+r+"</span></div>").data({self:this,pageIndex:n}).appendTo("#BRnavline").bt({contentSelector:'$(this).find(".query")',trigger:"hover",closeWhenOthersOpen:true,cssStyles:{padding:"12px 14px",backgroundColor:"#fff",border:"4px solid #e2dcc5",fontFamily:'"Lucida Grande","Arial",sans-serif',fontSize:"13px",color:"#615132"},shrinkToFit:false,width:"230px",padding:0,spikeGirth:0,spikeLength:0,overlap:"22px",overlay:false,killTitle:false,textzIndex:9999,boxzIndex:9998,wrapperzIndex:9997,offsetParent:null,positions:["top"],fill:"white",windowMargin:10,strokeWidth:0,cornerRadius:0,centerPointX:0,centerPointY:0,shadow:false}).hover(function(){e(".search,.chapter").removeClass("front");e(this).addClass("front")},function(){e(this).removeClass("front")}).bind("click",function(){e(this).data("self").jumpToIndex(e(this).data("pageIndex"))});e(f).animate({top:"-25px"},"slow")};BookReader.prototype.removeSearchResults=function(){this.removeSearchHilites();e("#BRnavpos .search").remove()};BookReader.prototype.addChapter=function(t,n,r){var i="Page";var s=BookReader.util.cssPercentage(r,this.numLeafs-1);e('<div class="chapter" style="left:'+s+';"><div class="title">'+t+"<span>|</span> "+i+" "+n+"</div></div>").appendTo("#BRnavline").data({self:this,pageIndex:r}).bt({contentSelector:'$(this).find(".title")',trigger:"hover",closeWhenOthersOpen:true,cssStyles:{padding:"12px 14px",backgroundColor:"#000",border:"4px solid #e2dcc5",fontFamily:'"Arial", sans-serif',fontSize:"12px",fontWeight:"700",color:"#fff",whiteSpace:"nowrap"},shrinkToFit:true,width:"200px",padding:0,spikeGirth:0,spikeLength:0,overlap:"21px",overlay:false,killTitle:true,textzIndex:9999,boxzIndex:9998,wrapperzIndex:9997,offsetParent:null,positions:["top"],fill:"black",windowMargin:10,strokeWidth:0,cornerRadius:0,centerPointX:0,centerPointY:0,shadow:false}).hover(function(){e(".search,.chapter").removeClass("front");e(this).addClass("front")},function(){e(this).removeClass("front")}).bind("click",function(){e(this).data("self").jumpToIndex(e(this).data("pageIndex"))})};BookReader.prototype.removeChapters=function(){e("#BRnavpos .chapter").remove()};BookReader.prototype.updateTOC=function(e){this.removeChapters();for(var t=0;t<e.length;t++){this.addChapterFromEntry(e[t])}};BookReader.prototype.addChapterFromEntry=function(t){var n=this.getPageIndex(t["pagenum"]);if(n){this.addChapter(t["title"],t["pagenum"],n)}e(".chapter").each(function(){e(this).hover(function(){e(this).addClass("front")},function(){e(this).removeClass("front")})});e(".search").each(function(){e(this).hover(function(){e(this).addClass("front")},function(){e(this).removeClass("front")})});e(".searchChap").each(function(){e(this).hover(function(){e(this).addClass("front")},function(){e(this).removeClass("front")})})};BookReader.prototype.initToolbar=function(t,n){if(n=="embed"){return}var r="";if(!navigator.userAgent.match(/mobile/i)){r="<button class='BRicon read modal'></button>"}e("#BookReader").append("<div id='BRtoolbar'>"+"<span id='BRtoolbarbuttons'>"+"<form action='javascript:br.search($(\"#textSrch\").val());' id='booksearch'><input type='search' id='textSrch' name='textSrch' val='' placeholder='Search inside'/><button type='submit' id='btnSrch' name='btnSrch'>GO</button></form>"+"<button class='BRicon play'></button>"+"<button class='BRicon pause'></button>"+"<button class='BRicon info'></button>"+"<button class='BRicon share'></button>"+r+"</span>"+"<span><a class='logo' href='"+this.logoURL+"'></a></span>"+"<span id='BRreturn'><a></a></span>"+"<div id='BRnavCntlTop' class='BRnabrbuvCntl'></div>"+"</div>");if(navigator.userAgent.match(/ipad/i)&&e.browser.webkit&&parseInt(e.browser.version,10)<=531){e("#BRtoolbarbuttons .info").hide();e("#BRtoolbarbuttons .share").hide()}e("#BRreturn a").attr("href",this.bookUrl).text(this.bookTitle);e("#BRtoolbar .BRnavCntl").addClass("BRup");e("#BRtoolbar .pause").hide();this.updateToolbarZoom(this.reduce);if(n=="embed"||n=="touch"){e("#BookReader a.logo").attr("target","_blank")}var i=e("#BRtoolbar");i.append();if(!this.canSwitchToMode(this.constMode2up)){i.find(".two_page_mode, .play, .pause").hide()}if(!this.canSwitchToMode(this.constModeThumb)){i.find(".thumbnail_mode").hide()}if(!(this.canSwitchToMode(this.constMode2up)||this.canSwitchToMode(this.constModeThumb))){i.find(".one_page_mode").hide()}var s=this;i.find(".share").colorbox({inline:true,opacity:"0.5",href:"#BRshare",onLoad:function(){s.autoStop();s.ttsStop()}});i.find(".info").colorbox({inline:true,opacity:"0.5",href:"#BRinfo",onLoad:function(){s.autoStop();s.ttsStop()}});e('<div style="display: none;"></div>').append(this.blankShareDiv()).append(this.blankInfoDiv()).appendTo(e("body"));e("#BRinfo .BRfloatTitle a").attr({href:this.bookUrl}).text(this.bookTitle).addClass("title");this.buildInfoDiv(e("#BRinfo"));this.buildShareDiv(e("#BRshare"))};BookReader.prototype.blankInfoDiv=function(){return e(['<div class="BRfloat" id="BRinfo">','<div class="BRfloatHead">About this book','<a class="floatShut" href="javascript:;" onclick="$.fn.colorbox.close();"><span class="shift">Close</span></a>',"</div>",'<div class="BRfloatBody">','<div class="BRfloatCover">',"</div>",'<div class="BRfloatMeta">','<div class="BRfloatTitle">',"<h2><a/></h2>","</div>","</div>","</div>",'<div class="BRfloatFoot">','<a href="http://openlibrary.org/dev/docs/bookreader">About the BookReader</a>',"</div>","</div>"].join("\n"))};BookReader.prototype.blankShareDiv=function(){return e(['<div class="BRfloat" id="BRshare">','<div class="BRfloatHead">',"Share",'<a class="floatShut" href="javascript:;" onclick="$.fn.colorbox.close();"><span class="shift">Close</span></a>',"</div>","</div>"].join("\n"))};BookReader.prototype.switchToolbarMode=function(t){if(1==t){e("#BRtoolbar .BRtoolbarzoom").show().css("display","inline");e("#BRtoolbar .BRtoolbarmode2").hide();e("#BRtoolbar .BRtoolbarmode3").hide();e("#BRtoolbar .BRtoolbarmode1").show().css("display","inline")}else if(2==t){e("#BRtoolbar .BRtoolbarzoom").show().css("display","inline");e("#BRtoolbar .BRtoolbarmode1").hide();e("#BRtoolbar .BRtoolbarmode3").hide();e("#BRtoolbar .BRtoolbarmode2").show().css("display","inline")}else{e("#BRtoolbar .BRtoolbarzoom").hide();e("#BRtoolbar .BRtoolbarmode2").hide();e("#BRtoolbar .BRtoolbarmode1").hide();e("#BRtoolbar .BRtoolbarmode3").show().css("display","inline")}};BookReader.prototype.updateToolbarZoom=function(t){var n;var r=null;if(this.mode==this.constMode2up){r=this.twoPage.autofit}else{r=this.onePage.autofit}if(r){n=r.slice(0,1).toUpperCase()+r.slice(1)}else{n=(100/t).toFixed(2);n=n.replace(/0+$/,"");n=n.replace(/\.$/,"");n+="%"}e("#BRzoom").text(n)};BookReader.prototype.bindNavigationHandlers=function(){var t=this;jIcons=e(".BRicon");jIcons.filter(".onepg").bind("click",function(e){t.switchMode(t.constMode1up)});jIcons.filter(".twopg").bind("click",function(e){t.switchMode(t.constMode2up)});jIcons.filter(".thumb").bind("click",function(e){t.switchMode(t.constModeThumb)});jIcons.filter(".fit").bind("fit",function(e){});jIcons.filter(".book_left").click(function(e){t.ttsStop();t.left();return false});jIcons.filter(".book_right").click(function(e){t.ttsStop();t.right();return false});jIcons.filter(".book_up").bind("click",function(n){if(e.inArray(t.mode,[t.constMode1up,t.constModeThumb])>=0){t.scrollUp()}else{t.prev()}return false});jIcons.filter(".book_down").bind("click",function(n){if(e.inArray(t.mode,[t.constMode1up,t.constModeThumb])>=0){t.scrollDown()}else{t.next()}return false});jIcons.filter(".print").click(function(e){t.printPage();return false});jIcons.filter(".embed").click(function(e){t.showEmbedCode();return false});jIcons.filter(".bookmark").click(function(e){t.showBookmarkCode();return false});jIcons.filter(".play").click(function(e){t.autoToggle();return false});jIcons.filter(".pause").click(function(e){t.autoToggle();return false});jIcons.filter(".book_top").click(function(e){t.first();return false});jIcons.filter(".book_bottom").click(function(e){t.last();return false});jIcons.filter(".book_leftmost").click(function(e){t.leftmost();return false});jIcons.filter(".book_rightmost").click(function(e){t.rightmost();return false});jIcons.filter(".read").click(function(e){t.ttsToggle();return false});jIcons.filter(".zoom_in").bind("click",function(){t.ttsStop();t.zoom(1);return false});jIcons.filter(".zoom_out").bind("click",function(){t.ttsStop();t.zoom(-1);return false});jIcons.filter(".full").bind("click",function(){if(t.ui=="embed"){var e=(window.location+"").replace("?ui=embed","");window.open(e)}});e(".BRnavCntl").click(function(){if(e("#BRnavCntlBtm").hasClass("BRdn")){e("#BRtoolbar").animate({top:-40});e("#BRnav").animate({bottom:-55});e("#BRnavCntlBtm").addClass("BRup").removeClass("BRdn");e("#BRnavCntlTop").addClass("BRdn").removeClass("BRup");e("#BRnavCntlBtm.BRnavCntl").animate({height:"45px"});e(".BRnavCntl").delay(1e3).animate({opacity:.25},1e3)}else{e("#BRtoolbar").animate({top:0});e("#BRnav").animate({bottom:0});e("#BRnavCntlBtm").addClass("BRdn").removeClass("BRup");e("#BRnavCntlTop").addClass("BRup").removeClass("BRdn");e("#BRnavCntlBtm.BRnavCntl").animate({height:"30px"});e(".BRvavCntl").animate({opacity:1})}});e("#BRnavCntlBtm").mouseover(function(){if(e(this).hasClass("BRup")){e(".BRnavCntl").animate({opacity:1},250)}});e("#BRnavCntlBtm").mouseleave(function(){if(e(this).hasClass("BRup")){e(".BRnavCntl").animate({opacity:.25},250)}});e("#BRnavCntlTop").mouseover(function(){if(e(this).hasClass("BRdn")){e(".BRnavCntl").animate({opacity:1},250)}});e("#BRnavCntlTop").mouseleave(function(){if(e(this).hasClass("BRdn")){e(".BRnavCntl").animate({opacity:.25},250)}});this.initSwipeData();e("#BookReader").die("mousemove.navigation").live("mousemove.navigation",{br:this},this.navigationMousemoveHandler);e(".BRpageimage").die("mousedown.swipe").live("mousedown.swipe",{br:this},this.swipeMousedownHandler);this.bindMozTouchHandlers()};BookReader.prototype.unbindNavigationHandlers=function(){e("#BookReader").die("mousemove.navigation")};BookReader.prototype.navigationMousemoveHandler=function(t){if(t.data["br"].uiAutoHide){var n=e(document).height()-75;if(t.pageY<76||t.pageY>n){t.data["br"].hideNavigation()}else{t.data["br"].showNavigation()}}};BookReader.prototype.initSwipeData=function(e,t){this._swipe={mightBeSwiping:false,didSwipe:false,mightBeDraggin:false,didDrag:false,startTime:(new Date).getTime(),startX:e,startY:t,lastX:e,lastY:t,deltaX:0,deltaY:0,deltaT:0}};BookReader.prototype.swipeMousedownHandler=function(t){var n=t.data["br"];if(t.which==3){if(n.protected){return false}return true}e(t.target).bind("mouseout.swipe",{br:n},n.swipeMouseupHandler).bind("mouseup.swipe",{br:n},n.swipeMouseupHandler).bind("mousemove.swipe",{br:n},n.swipeMousemoveHandler);n.initSwipeData(t.clientX,t.clientY);n._swipe.mightBeSwiping=true;n._swipe.mightBeDragging=true;t.preventDefault();t.returnValue=false;t.cancelBubble=true;return false};BookReader.prototype.swipeMousemoveHandler=function(t){var n=t.data["br"]._swipe;if(!n.mightBeSwiping){return}n.deltaX=t.clientX-n.startX;n.deltaY=t.clientY-n.startY;n.deltaT=(new Date).getTime()-n.startTime;var r=Math.abs(n.deltaX);var i=Math.abs(n.deltaY);var s=Math.min(e("#BookReader").width()/5,80);var o=400;if(r>i&&r>s&&n.deltaT<o){n.mightBeSwiping=false;n.didSwipe=true;if(t.data["br"].mode==t.data["br"].constMode2up){if(n.deltaX<0){t.data["br"].right()}else{t.data["br"].left()}}}if(n.deltaT>o&&!n.didSwipe){if(n.mightBeDragging){n.didDrag=true;e("#BRcontainer").scrollTop(e("#BRcontainer").scrollTop()-t.clientY+n.lastY).scrollLeft(e("#BRcontainer").scrollLeft()-t.clientX+n.lastX)}}n.lastX=t.clientX;n.lastY=t.clientY;t.preventDefault();t.returnValue=false;t.cancelBubble=true;return false};BookReader.prototype.swipeMouseupHandler=function(t){var n=t.data["br"]._swipe;n.mightBeSwiping=false;n.mightBeDragging=false;e(t.target).unbind("mouseout.swipe").unbind("mouseup.swipe").unbind("mousemove.swipe");if(n.didSwipe||n.didDrag){t.preventDefault();t.returnValue=false;t.cancelBubble=true;return false}return true};BookReader.prototype.bindMozTouchHandlers=function(){var t=this;e("#BookReader").bind("MozTouchDown",function(e){if(this.mode==this.constMode2up){e.preventDefault()}}).bind("MozTouchMove",function(e){if(this.mode==this.constMode2up){e.preventDefault()}}).bind("MozTouchUp",function(e){if(this.mode=this.constMode2up){e.preventDefault()}})};BookReader.prototype.navigationIsVisible=function(){var t=e("#BRtoolbar").offset();var n=t.top;if(n==0){return true}return false};BookReader.prototype.hideNavigation=function(){if(this.navigationIsVisible()){e("#BRtoolbar").animate({top:-60});e("#BRnav").animate({bottom:-60})}};BookReader.prototype.showNavigation=function(){if(!this.navigationIsVisible()){e("#BRtoolbar").animate({top:0});e("#BRnav").animate({bottom:0})}};BookReader.prototype.firstDisplayableIndex=function(){if(this.mode!=this.constMode2up){return 0}if("rl"!=this.pageProgression){if(this.getPageSide(0)=="L"){return 0}else{return-1}}else{if(this.getPageSide(0)=="R"){return 0}else{return-1}}};BookReader.prototype.lastDisplayableIndex=function(){var e=this.numLeafs-1;if(this.mode!=this.constMode2up){return e}if("rl"!=this.pageProgression){if(this.getPageSide(e)=="R"){return e}else{return e+1}}else{if(this.getPageSide(e)=="L"){return e}else{return e+1}}};BookReader.prototype.shortTitle=function(e){if(this.bookTitle.length<e){return this.bookTitle}var t=this.bookTitle.substr(0,e-3);t+="...";return t};BookReader.prototype.updateFromParams=function(e){if("undefined"!=typeof e.mode){this.switchMode(e.mode)}if("undefined"!=typeof e.searchTerm){if(this.searchTerm!=e.searchTerm){this.search(e.searchTerm)}}if("undefined"!=typeof e.index){if(e.index!=this.currentIndex()){this.jumpToIndex(e.index)}}else if("undefined"!=typeof e.page){if(e.page!=this.getPageNum(this.currentIndex())){this.jumpToPage(e.page)}}};BookReader.prototype.paramsFromFragment=function(e){var t={};if(e.substr(0,1)=="#"){e=e.substr(1)}var n=parseInt(/^\d+$/.exec(e));if(!isNaN(n)){t.index=n;return t}var r=e.split("/");var i={};for(var s=0;s<r.length;s+=2){i[r[s]]=r[s+1]}if("1up"==i["mode"]){t.mode=this.constMode1up}else if("2up"==i["mode"]){t.mode=this.constMode2up}else if("thumb"==i["mode"]){t.mode=this.constModeThumb}if("undefined"!=typeof i["page"]){t.page=i["page"]}if(i["search"]!=undefined){t.searchTerm=BookReader.util.decodeURIComponentPlus(i["search"])}return t};BookReader.prototype.paramsFromCurrent=function(){var e={};var t=this.currentIndex();var n=this.getPageNum(t);if(n===0||n){e.page=n}e.index=t;e.mode=this.mode;if(this.searchHighlightVisible()){e.searchTerm=this.searchTerm}return e};BookReader.prototype.fragmentFromParams=function(e){var t="/";var n=[];if("undefined"!=typeof e.page){n.push("page",e.page)}else{if("undefined"!=typeof e.index){n.push("page","n"+e.index)}}if("undefined"!=typeof e.mode){if(e.mode==this.constMode1up){n.push("mode","1up")}else if(e.mode==this.constMode2up){n.push("mode","2up")}else if(e.mode==this.constModeThumb){n.push("mode","thumb")}else{throw"fragmentFromParams called with unknown mode "+e.mode}}if(e.searchTerm){n.push("search",e.searchTerm)}return BookReader.util.encodeURIComponentPlus(n.join(t)).replace(/%2F/g,"/")};BookReader.prototype.getPageIndex=function(e){var t=this.getPageIndices(e);if(t.length>0){return t[t.length-1]}return undefined};BookReader.prototype.getPageIndices=function(e){var t=[];if(e.slice(0,1)=="n"){try{var n=e.slice(1,e.length);var r=parseInt(n);t.push(r);return t}catch(i){}}var s;for(s=0;s<this.numLeafs;s++){if(this.getPageNum(s)==e){t.push(s)}}return t};BookReader.prototype.getPageName=function(e){return"Page "+this.getPageNum(e)};BookReader.prototype.updateLocationHash=function(){var e="#"+this.fragmentFromParams(this.paramsFromCurrent());window.location.replace(e);this.oldLocationHash=e};BookReader.prototype.startLocationPolling=function(){var e=this;e.oldLocationHash=window.location.hash;if(this.locationPollId){clearInterval(this.locationPollID);this.locationPollId=null}this.locationPollId=setInterval(function(){var t=window.location.hash;if(t!=e.oldLocationHash){if(t!=e.oldUserHash){e.ttsStop();if(e.animating){e.autoStop();e.animationFinishedCallback=function(){e.updateFromParams(e.paramsFromFragment(t))}}else{e.updateFromParams(e.paramsFromFragment(t))}e.oldUserHash=t}}},500)};BookReader.prototype.canSwitchToMode=function(e){if(e==this.constMode2up||e==this.constModeThumb){if(this.numLeafs<2){return false}}return true};BookReader.prototype.searchHighlightVisible=function(){var e=this.searchResults;if(null==e)return false;if(this.constMode2up==this.mode){var t=Array(this.twoPage.currentIndexL,this.twoPage.currentIndexR)}else if(this.constMode1up==this.mode){var t=Array();t[0]=this.currentIndex()}else{return false}var n,r;for(n=0;n<e.matches.length;n++){for(r=0;r<e.matches[n].par[0].boxes.length;r++){var i=e.matches[n].par[0].boxes[r];var s=this.leafNumToIndex(i.page);if(jQuery.inArray(s,t)>=0){return true}}}return false};BookReader.prototype._getPageWidth=function(e){e=BookReader.util.clamp(e,0,this.numLeafs-1);return this.getPageWidth(e)};BookReader.prototype._getPageHeight=function(e){e=BookReader.util.clamp(e,0,this.numLeafs-1);return this.getPageHeight(e)};BookReader.prototype._getPageURI=function(e,t,n){if(e<0||e>=this.numLeafs){return this.imagesBaseURL+"transparent.png"}if("undefined"==typeof t){var r=this.getPageHeight(e)/this.twoPage.height;var i;if(r<2){i=1}else if(r<4){i=2}else if(r<8){i=4}else if(r<16){i=8}else if(r<32){i=16}else{i=32}t=i}return this.getPageURI(e,t,n)};BookReader.prototype.gotOpenLibraryRecord=function(t,n){if(n){if(n["table_of_contents"]){t.updateTOC(n["table_of_contents"])}t.bookUrl=t.olHost+n.key;t.bookTitle=n["title"];e("#BRreturn a").attr({href:t.bookUrl,title:"Go to this book's page on Open Library"});e("#BRreturn a").text(t.bookTitle);e("#BRinfo").remove();e("#BRshare").after(t.blankInfoDiv());t.buildInfoDiv(e("#BRinfo"));if(t.olAuth){var r=t.olHost+n.key+"/do_return/borrow";var i=t.olHost+n.key+"/borrow";e('<form id="BRreturnform" action="'+r+'" method="post"><input type="submit" value="Return book" onclick="olAuth.deleteCookies();"/><input type="hidden" name="action" value="return" /></form>').appendTo("#BRreturn")}else{e("<a/>").attr({href:t.bookUrl,title:"Go to this book's page on Open Library"}).text("On openlibrary.org").appendTo("#BRreturn")}e("#BRreturn").css({"line-height":"19px"});e("#BRreturn a").css({height:"18px"})}};BookReader.util={disableSelect:function(e){e.bind("mousedown",function(e){return false});e[0].onselectstart=function(e){return false}},clamp:function(e,t,n){return Math.min(Math.max(e,t),n)},cssPercentage:function(e,t){return(e+0)/t*100+"%"},notInArray:function(e,t){return!(jQuery.inArray(e,t)>=0)},getIFrameDocument:function(e){var t=e.contentWindow||e.contentDocument;return t.document||t},escapeHTML:function(e){return e.replace(/&/g,"&").replace(/>/g,">").replace(/</g,"<").replace(/"/g,""")},decodeURIComponentPlus:function(e){return decodeURIComponent(e).replace(/\+/g," ")},encodeURIComponentPlus:function(e){return encodeURIComponent(e).replace(/%20/g,"+")}};BookReader.prototype.ttsToggle=function(){this.autoStop();if(false==this.ttsPlaying){this.ttsPlaying=true;this.showProgressPopup("Loading audio...");if(soundManager.supported()){this.ttsStart()}else{soundManager.onready(function(e){if(e.success){this.ttsStart()}else{alert("Could not load soundManager2, possibly due to FlashBlock. Audio playback is disabled")}},this)}}else{this.ttsStop()}};BookReader.prototype.ttsStart=function(){if(soundManager.debugMode)console.log("starting readAloud");if(this.constModeThumb==this.mode)this.switchMode(this.constMode1up);this.ttsIndex=this.currentIndex();this.ttsFormat="mp3";if(e.browser.mozilla){this.ttsFormat="ogg"}this.ttsGetText(this.ttsIndex,"ttsStartCB")};BookReader.prototype.ttsStop=function(){if(false==this.ttsPlaying)return;if(soundManager.debugMode)console.log("stopping readaloud");soundManager.stopAll();soundManager.destroySound("chunk"+this.ttsIndex+"-"+this.ttsPosition);this.ttsRemoveHilites();this.removeProgressPopup();this.ttsPlaying=false;this.ttsIndex=null;this.ttsPosition=-1;this.ttsBuffering=false;this.ttsPoller=null};BookReader.prototype.ttsGetText=function(t,n){var r="http://"+this.server+"/BookReader/BookReaderGetTextWrapper.php?path="+this.bookPath+"_djvu.xml&page="+t;this.ttsAjax=e.ajax({url:r,dataType:"jsonp",jsonpCallback:n})};BookReader.prototype.ttsStartCB=function(e){if(soundManager.debugMode)console.log("ttsStartCB got data: "+e);this.ttsChunks=e;this.ttsHilites=[];if(0==e.length){if(soundManager.debugMode)console.log("first page is blank!");if(this.ttsAdvance(true)){this.ttsGetText(this.ttsIndex,"ttsStartCB")}return}this.showProgressPopup("Loading audio...");this.ttsPosition=-1;var t=soundManager.createSound({id:"chunk"+this.ttsIndex+"-0",url:"http://"+this.server+"/BookReader/BookReaderGetTTS.php?string="+escape(e[0][0])+"&format=."+this.ttsFormat,onload:function(){this.br.removeProgressPopup()},onbufferchange:function(){if(false==this.isBuffering)this.br.removeProgressPopup()}});t.br=this;t.load();this.ttsNextChunk()};BookReader.prototype.showProgressPopup=function(t){if(this.popup)return;this.popup=document.createElement("div");e(this.popup).css({top:e("#BookReader").height()*.5-100+"px",left:(e("#BookReader").width()-300)*.5+"px"}).attr("className","BRprogresspopup");var n=document.createElement("div");e(n).css({height:"20px"}).attr("className","BRprogressbar");e(this.popup).append(n);if(t){var r=document.createElement("div");r.innerHTML=t;e(this.popup).append(r)}e(this.popup).appendTo("#BookReader")};BookReader.prototype.removeProgressPopup=function(){e(this.popup).remove();this.popup=null};BookReader.prototype.ttsNextPageCB=function(e){this.ttsNextChunks=e;if(soundManager.debugMode)console.log("preloaded next chunks.. data is "+e);if(true==this.ttsBuffering){if(soundManager.debugMode)console.log("ttsNextPageCB: ttsBuffering is true");this.ttsBuffering=false}};BookReader.prototype.ttsLoadChunk=function(e,t,n){var r=soundManager.createSound({id:"chunk"+e+"-"+t,url:"http://"+this.server+"/BookReader/BookReaderGetTTS.php?string="+escape(n)+"&format=."+this.ttsFormat});r.br=this;r.load()};BookReader.prototype.ttsNextChunk=function(){if(soundManager.debugMode)console.log("nextchunk pos="+this.ttsPosition);if(-1!=this.ttsPosition){soundManager.destroySound("chunk"+this.ttsIndex+"-"+this.ttsPosition)}this.ttsRemoveHilites();var e=this.ttsAdvance();if(e){this.ttsNextChunkPhase2()}};BookReader.prototype.ttsNextChunkPhase2=function(){if(null==this.ttsChunks){alert("error: ttsChunks is null?");return}if(0==this.ttsChunks.length){if(soundManager.debugMode)console.log("ttsNextChunk2: ttsChunks.length is zero.. hacking...");this.ttsStartCB(this.ttsChunks);return}if(soundManager.debugMode)console.log("next chunk is "+this.ttsPosition);if(0==this.ttsPosition){if(this.ttsIndex<this.numLeafs-1){this.ttsGetText(this.ttsIndex+1,"ttsNextPageCB")}}this.ttsPrefetchAudio();this.ttsPlay()};BookReader.prototype.ttsAdvance=function(e){this.ttsPosition++;if(this.ttsPosition>=this.ttsChunks.length){if(this.ttsIndex==this.numLeafs-1){if(soundManager.debugMode)console.log("tts stop");return false}else{if(null!=this.ttsNextChunks||e){if(soundManager.debugMode)console.log("moving to next page!");this.ttsIndex++;this.ttsPosition=0;this.ttsChunks=this.ttsNextChunks;this.ttsNextChunks=null;if(2==this.mode){if(this.ttsIndex!=this.twoPage.currentIndexL&&this.ttsIndex!=this.twoPage.currentIndexR){if(!e){this.animationFinishedCallback=this.ttsNextChunkPhase2;this.next();return false}else{this.next();return true}}else{return true}}}else{if(soundManager.debugMode)console.log("ttsAdvance: ttsNextChunks is null");return false}}}return true};BookReader.prototype.ttsPrefetchAudio=function(){if(false!=this.ttsBuffering){alert("TTS Error: prefetch() called while content still buffering!");return}var e=this.ttsPosition+1;if(e<this.ttsChunks.length){this.ttsLoadChunk(this.ttsIndex,e,this.ttsChunks[e][0])}else{if(soundManager.debugMode)console.log("preloading chunk 0 from next page, index="+(this.ttsIndex+1));if(null!=this.ttsNextChunks){if(0!=this.ttsNextChunks.length){this.ttsLoadChunk(this.ttsIndex+1,0,this.ttsNextChunks[0][0])}else{if(soundManager.debugMode)console.log("prefetchAudio(): ttsNextChunks is zero length!")}}else{if(soundManager.debugMode)console.log("ttsNextChunks is null, not preloading next page");this.ttsBuffering=true}}};BookReader.prototype.ttsPlay=function(){var e=this.ttsChunks[this.ttsPosition];if(soundManager.debugMode){console.log("ttsPlay position = "+this.ttsPosition);console.log("chunk = "+e);console.log(this.ttsChunks)}if(2==this.mode){this.ttsHilite2UP(e)}else{this.ttsHilite1UP(e)}this.ttsScrollToChunk(e);if(false==this.ttsBuffering){soundManager.play("chunk"+this.ttsIndex+"-"+this.ttsPosition,{onfinish:function(){br.ttsNextChunk()}})}else{soundManager.play("chunk"+this.ttsIndex+"-"+this.ttsPosition,{onfinish:function(){br.ttsStartPolling()}})}};BookReader.prototype.ttsScrollToChunk=function(t){if(this.constMode1up!=this.mode)return;var n=0;var r;var i;for(i=0;i<this.ttsIndex;i++){r=parseInt(this._getPageHeight(i)/this.reduce);n+=r+this.padding}var s=t[1][3];var o=t[t.length-1][1];var u=n+s/this.reduce;var a=n+o/this.reduce;if(soundManager.debugMode)console.log("leafTop = "+n+" topOfFirstChunk = "+u+" botOfLastChunk = "+a);var f=e("#BRcontainer").attr("scrollTop");var l=f+e("#BRcontainer").height();if(soundManager.debugMode)console.log("containerTop = "+f+" containerBot = "+l);if(u<f||a>l){e("#BRcontainer").animate({scrollTop:u},"fast")}};BookReader.prototype.ttsHilite1UP=function(t){var n;for(n=1;n<t.length;n++){var r=t[n][0];var i=t[n][1];var s=t[n][2];var o=t[n][3];var u=document.createElement("div");this.ttsHilites.push(u);e(u).attr("className","BookReaderSearchHilite").appendTo("#pagediv"+this.ttsIndex);e(u).css({width:(s-r)/this.reduce+"px",height:(i-o)/this.reduce+"px",left:r/this.reduce+"px",top:o/this.reduce+"px"})}};BookReader.prototype.ttsHilite2UP=function(t){var n;for(n=1;n<t.length;n++){var r=t[n][0];var i=t[n][1];var s=t[n][2];var o=t[n][3];var u=document.createElement("div");this.ttsHilites.push(u);e(u).attr("className","BookReaderSearchHilite").css("zIndex",3).appendTo("#BRtwopageview");this.setHilightCss2UP(u,this.ttsIndex,r,s,o,i)}};BookReader.prototype.ttsRemoveHilites=function(t){e(this.ttsHilites).remove();this.ttsHilites=[]};BookReader.prototype.ttsStartPolling=function(){if(soundManager.debugMode)console.log("Starting the TTS poller...");var e=this;this.ttsPoller=setInterval(function(){if(e.ttsBuffering){return}if(soundManager.debugMode)console.log("TTS buffering finished!");clearInterval(e.ttsPoller);e.ttsPoller=null;e.ttsPrefetchAudio();e.ttsNextChunk()},500)};BookReader.prototype.buildShareDiv=function(t){var n=document.location+"";var r=(n+"").replace(/#.*/,"");var i=this;var s=e(["<p>Copy and paste one of these options to share this book elsewhere.</p>",'<form method="post" action="">',"<fieldset>",'<label for="pageview">Link to this page view:</label>','<input type="text" name="pageview" id="pageview" value="'+n+'"/>',"</fieldset>","<fieldset>",'<label for="booklink">Link to the book:</label>','<input type="text" name="booklink" id="booklink" value="'+r+'"/>',"</fieldset>","<fieldset>",'<label for="iframe">Embed a mini Book Reader:</label>','<fieldset class="sub">','<label class="sub">','<input type="radio" name="pages" value="'+this.constMode1up+'" checked="checked"/>',"1 page","</label>",'<label class="sub">','<input type="radio" name="pages" value="'+this.constMode2up+'"/>',"2 pages","</label>",'<label class="sub">','<input type="checkbox" name="thispage" value="thispage"/>',"Open to this page?","</label>","</fieldset>",'<textarea cols="30" rows="4" name="iframe" class="BRframeEmbed"></textarea>','<p class="meta"><strong>NOTE:</strong> We\'ve tested EMBED on blogspot.com blogs as well as self-hosted Wordpress blogs. This feature will NOT work on wordpress.com blogs.</p>',"</fieldset>",'<fieldset class="center">','<button type="button" onclick="$.fn.colorbox.close();">Finished</button>',"</fieldset>","</form>"].join("\n"));s.appendTo(t);s.find("input").bind("change",function(){var t=e(this).parents("form:first");var n={};n.mode=e(t.find("input[name=pages]:checked")).val();if(t.find("input[name=thispage]").attr("checked")){n.page=i.getPageNum(i.currentIndex())}var r="480px";var s="430px";t.find(".BRframeEmbed").val(i.getEmbedCode(r,s,n))});s.find("input[name=thispage]").trigger("change");s.find("input, textarea").bind("focus",function(){this.select()});s.appendTo(t);s=""};BookReader.prototype.buildInfoDiv=function(e){e.find(".BRfloatTitle a").attr({href:this.bookUrl,alt:this.bookTitle}).text(this.bookTitle)};BookReader.prototype.initUIStrings=function(){var t={".logo":"Go to Archive.org",".zoom_in":"Zoom in",".zoom_out":"Zoom out",".onepg":"One-page view",".twopg":"Two-page view",".thumb":"Thumbnail view",".print":"Print this page",".embed":"Embed BookReader",".link":"Link to this book (and page)",".bookmark":"Bookmark this page",".read":"Read this book aloud",".share":"Share this book",".info":"About this book",".full":"Show fullscreen",".book_left":"Flip left",".book_right":"Flip right",".book_up":"Page up",".book_down":"Page down",".play":"Play",".pause":"Pause",".BRdn":"Show/hide nav bar",".BRup":"Show/hide nav bar",".book_top":"First page",".book_bottom":"Last page"};if("rl"==this.pageProgression){t[".book_leftmost"]="Last page";t[".book_rightmost"]="First page"}else{t[".book_leftmost"]="First page";t[".book_rightmost"]="Last page"}for(var n in t){if(t.hasOwnProperty(n)){e("#BookReader").find(n).attr("title",t[n])}}}})(jQuery)